# Prompt Card System - Enhanced Development Makefile
# ==================================================

.PHONY: help dev dev-gpu dev-cpu build test clean logs restart demo demo-clean demo-quick demo-presentation demo-load-data demo-status demo-reset demo-stop demo-export docs-demo
.DEFAULT_GOAL := help

# Colors for output
RED := \033[0;31m
GREEN := \033[0;32m
YELLOW := \033[0;33m
BLUE := \033[0;34m
PURPLE := \033[0;35m
CYAN := \033[0;36m
WHITE := \033[0;37m
RESET := \033[0m

# Default target
help: ## Show this help message
	@echo "$(BLUE)Prompt Card System - Development Commands$(RESET)"
	@echo "========================================"
	@awk 'BEGIN {FS = ":.*?## "} /^[a-zA-Z_-]+:.*?## / {printf "$(CYAN)%-25s$(RESET) %s\n", $$1, $$2}' $(MAKEFILE_LIST)

# Quick Commands
setup: ## First-time setup for new developers with progress tracking
	@echo "$(GREEN)üöÄ Setting up Prompt Card System for development...$(RESET)"
	@./scripts/statusline.sh --phase Setup --msg "Starting first-time setup" --extras "steps=4/4"
	@echo "$(YELLOW)Step 1: Checking prerequisites...$(RESET)"
	@./scripts/statusline.sh --progress "Checking prerequisites" --extras "step=1/4"
	@$(MAKE) check-prerequisites
	@echo "$(YELLOW)Step 2: Creating environment files...$(RESET)"
	@./scripts/statusline.sh --progress "Creating environment files" --extras "step=2/4"
	@$(MAKE) create-env
	@echo "$(YELLOW)Step 3: Building containers...$(RESET)"
	@./scripts/statusline.sh --progress "Building containers" --extras "step=3/4"
	@$(MAKE) build
	@echo "$(YELLOW)Step 4: Starting development environment...$(RESET)"
	@./scripts/statusline.sh --progress "Starting development environment" --extras "step=4/4"
	@$(MAKE) dev
	@./scripts/statusline.sh --ok "Setup complete! Visit http://localhost:3000" --extras "duration=$$(date +%s)s"
	@echo "$(GREEN)‚úÖ Setup complete! Visit http://localhost:3000$(RESET)"

check-prerequisites: ## Check system prerequisites with detailed validation
	@echo "$(BLUE)üîç Checking prerequisites...$(RESET)"
	@./scripts/statusline.sh --phase Setup --msg "Validating system requirements"
	@command -v docker >/dev/null 2>&1 || (./scripts/statusline.sh --error "Docker not found" --extras "install=https://docs.docker.com/install" && exit 1)
	@command -v docker-compose >/dev/null 2>&1 || command -v docker >/dev/null 2>&1 && docker compose version >/dev/null 2>&1 || (./scripts/statusline.sh --error "Docker Compose not found" --extras "install=docker-compose-plugin" && exit 1)
	@./scripts/statusline.sh --ok "Docker requirements met" --extras "docker=$$(docker --version | awk '{print $$3}' | tr -d ',') compose=$$(docker-compose --version 2>/dev/null | awk '{print $$3}' || docker compose version --short)"
	@echo "$(GREEN)‚úÖ Docker and Docker Compose found$(RESET)"
	@if command -v nvidia-smi >/dev/null 2>&1; then \
		./scripts/statusline.sh --ok "GPU support available" --extras "gpu=$$(nvidia-smi --query-gpu=name --format=csv,noheader | head -1)"; \
		echo "$(GREEN)üéÆ GPU detected and available$(RESET)"; \
	else \
		./scripts/statusline.sh --warn "No GPU detected, using CPU-only" --extras "mode=cpu-only performance=reduced"; \
		echo "$(YELLOW)üíª No GPU detected, will use CPU-only mode$(RESET)"; \
	fi

create-env: ## Create environment files from examples
	@echo "$(BLUE)üìù Creating environment files...$(RESET)"
	@if [ ! -f .env ]; then \
		echo "$(YELLOW)Creating .env from .env.example...$(RESET)"; \
		cp .env.example .env 2>/dev/null || echo "$(YELLOW)No .env.example found, skipping...$(RESET)"; \
	fi
	@if [ ! -f .env.dev ]; then \
		echo "$(YELLOW)Creating .env.dev from .env.dev.example...$(RESET)"; \
		cp .env.dev.example .env.dev 2>/dev/null || echo "$(YELLOW)No .env.dev.example found, skipping...$(RESET)"; \
	fi
	@echo "$(GREEN)‚úÖ Environment files ready$(RESET)"

# Development Commands
dev: ## Start full development environment (auto-detects GPU)
	@echo "$(GREEN)üöÄ Starting development environment...$(RESET)"
	@./scripts/statusline.sh --phase Setup --msg "Auto-detecting hardware and starting environment"
	@if command -v nvidia-smi >/dev/null 2>&1; then \
		./scripts/statusline.sh --ok "GPU detected, starting with GPU support" --extras "mode=gpu hardware=nvidia"; \
		echo "$(GREEN)üéÆ GPU detected, starting with GPU support...$(RESET)"; \
		$(MAKE) dev-gpu; \
	else \
		./scripts/statusline.sh --warn "No GPU detected, starting CPU-only" --extras "mode=cpu performance=limited"; \
		echo "$(YELLOW)üíª No GPU detected, starting CPU-only...$(RESET)"; \
		$(MAKE) dev-cpu; \
	fi

dev-full: ## Start complete development stack with all features
	@echo "$(PURPLE)üåü Starting FULL development stack with advanced features...$(RESET)"
	@echo "$(YELLOW)üé§ Voice Interface: ENABLED$(RESET)"
	@echo "$(YELLOW)üîó Blockchain Audit: ENABLED$(RESET)"
	@echo "$(YELLOW)ü§ù Collaboration: ENABLED$(RESET)"
	@echo "$(YELLOW)üìä Advanced Monitoring: ENABLED$(RESET)"
	@echo "$(YELLOW)üè¢ Multi-Tenant: ENABLED$(RESET)"
	@if command -v nvidia-smi >/dev/null 2>&1; then \
		ENABLE_VOICE_INTERFACE=true ENABLE_BLOCKCHAIN_AUDIT=true ENABLE_COLLABORATION=true ENABLE_MONITORING=true MULTI_TENANT_MODE=true docker-compose --profile gpu --profile monitoring --profile tools -f docker-compose.dev.yml up -d; \
	else \
		ENABLE_VOICE_INTERFACE=true ENABLE_BLOCKCHAIN_AUDIT=true ENABLE_COLLABORATION=true ENABLE_MONITORING=true MULTI_TENANT_MODE=true docker-compose --profile cpu --profile monitoring --profile tools -f docker-compose.dev.yml up -d; \
	fi
	@echo "$(YELLOW)‚è≥ Waiting for services to initialize...$(RESET)"
	@sleep 15
	@$(MAKE) init-models
	@$(MAKE) show-full-status

dev-gpu: ## Start development with GPU support
	@echo "$(GREEN)üéÆ Starting development environment with GPU support...$(RESET)"
	@./scripts/statusline.sh --phase Deploy --msg "Starting GPU-enabled containers"
	@if docker-compose --profile gpu -f docker-compose.dev.yml up -d; then \
		./scripts/statusline.sh --progress "Services starting, waiting for readiness" --extras "gpu=enabled timeout=60s"; \
		echo "$(YELLOW)‚è≥ Waiting for services to start...$(RESET)"; \
		sleep 10; \
		$(MAKE) init-models; \
		$(MAKE) show-status; \
		./scripts/statusline.sh --ok "GPU development environment ready" --extras "services=frontend,backend,ollama-gpu,redis"; \
	else \
		./scripts/statusline.sh --error "Failed to start GPU environment" --extras "fallback=cpu-mode"; \
		exit 1; \
	fi

dev-cpu: ## Start development environment (CPU only)
	@echo "$(YELLOW)üíª Starting development environment (CPU only)...$(RESET)"
	@./scripts/statusline.sh --phase Deploy --msg "Starting CPU-only containers"
	@if docker-compose --profile cpu -f docker-compose.dev.yml up -d; then \
		./scripts/statusline.sh --progress "Services starting, waiting for readiness" --extras "mode=cpu timeout=60s"; \
		echo "$(YELLOW)‚è≥ Waiting for services to start...$(RESET)"; \
		sleep 10; \
		$(MAKE) init-models; \
		$(MAKE) show-status; \
		./scripts/statusline.sh --ok "CPU development environment ready" --extras "services=frontend,backend-cpu,ollama-cpu,redis"; \
	else \
		./scripts/statusline.sh --error "Failed to start CPU environment" --extras "check=docker-compose,resources"; \
		exit 1; \
	fi

dev-minimal: ## Start minimal development (frontend + backend only)
	@echo "$(CYAN)‚ö° Starting minimal development environment...$(RESET)"
	@if command -v nvidia-smi >/dev/null 2>&1; then \
		docker-compose -f docker-compose.dev.yml up -d frontend backend redis; \
	else \
		docker-compose -f docker-compose.dev.yml up -d frontend backend-cpu redis; \
	fi
	@$(MAKE) show-status

# Feature-specific environments
dev-voice: ## Start development with Voice Interface enabled
	@echo "$(PURPLE)üé§ Starting development with Voice Interface...$(RESET)"
	@ENABLE_VOICE_INTERFACE=true $(MAKE) dev
	@echo "$(GREEN)‚úÖ Voice Interface enabled - 6 languages supported$(RESET)"

dev-blockchain: ## Start development with Blockchain Audit enabled
	@echo "$(BLUE)üîó Starting development with Blockchain Audit...$(RESET)"
	@ENABLE_BLOCKCHAIN_AUDIT=true $(MAKE) dev
	@echo "$(GREEN)‚úÖ Blockchain Audit enabled - Smart contracts active$(RESET)"

dev-collaboration: ## Start development with Real-time Collaboration
	@echo "$(CYAN)ü§ù Starting development with Collaboration features...$(RESET)"
	@ENABLE_COLLABORATION=true $(MAKE) dev
	@echo "$(GREEN)‚úÖ Real-time Collaboration enabled$(RESET)"

dev-monitoring: ## Start development with Advanced Monitoring
	@echo "$(YELLOW)üìä Starting development with Advanced Monitoring...$(RESET)"
	@ENABLE_MONITORING=true docker-compose --profile monitoring -f docker-compose.dev.yml up -d
	@$(MAKE) monitoring
	@echo "$(GREEN)‚úÖ Advanced Monitoring enabled$(RESET)"

dev-enterprise: ## Start development with Multi-Tenant features
	@echo "$(PURPLE)üè¢ Starting development with Enterprise Multi-Tenant...$(RESET)"
	@MULTI_TENANT_MODE=true $(MAKE) dev
	@echo "$(GREEN)‚úÖ Multi-Tenant mode enabled$(RESET)"

# Model Management
init-models: ## Initialize LLM models
	@echo "$(BLUE)üì• Initializing models...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "ollama"; then \
		docker-compose --profile init -f docker-compose.dev.yml run --rm model-init || echo "$(YELLOW)Model initialization skipped$(RESET)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Ollama not running, skipping model initialization$(RESET)"; \
	fi

models-list: ## List available models
	@echo "$(BLUE)üìã Available models:$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec ollama ollama list 2>/dev/null || \
	docker-compose -f docker-compose.dev.yml exec ollama-cpu ollama list 2>/dev/null || \
	echo "$(YELLOW)‚ö†Ô∏è  Ollama not available$(RESET)"

models-pull: ## Pull additional models (specify MODEL=model_name)
	@if [ -z "$(MODEL)" ]; then \
		echo "$(RED)‚ùå Please specify MODEL name: make models-pull MODEL=llama2$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üì• Pulling model: $(MODEL)...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec ollama ollama pull $(MODEL) || \
	docker-compose -f docker-compose.dev.yml exec ollama-cpu ollama pull $(MODEL)

models-remove: ## Remove model (specify MODEL=model_name)
	@if [ -z "$(MODEL)" ]; then \
		echo "$(RED)‚ùå Please specify MODEL name: make models-remove MODEL=llama2$(RESET)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)üóëÔ∏è  Removing model: $(MODEL)...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec ollama ollama rm $(MODEL) || \
	docker-compose -f docker-compose.dev.yml exec ollama-cpu ollama rm $(MODEL)

# Development Tools
tools: ## Start development tools (Adminer, Redis Commander)
	@echo "$(CYAN)üîß Starting development tools...$(RESET)"
	@docker-compose --profile tools -f docker-compose.dev.yml up -d
	@echo "$(GREEN)üåê Development tools available:$(RESET)"
	@echo "   $(CYAN)‚Ä¢ Adminer (Database):$(RESET) http://localhost:8080"
	@echo "   $(CYAN)‚Ä¢ Redis Commander:$(RESET) http://localhost:8081"

monitoring: ## Start monitoring stack (Prometheus + Grafana)
	@echo "$(YELLOW)üìä Starting monitoring stack...$(RESET)"
	@docker-compose --profile monitoring -f docker-compose.dev.yml up -d
	@echo "$(GREEN)üìà Monitoring stack available:$(RESET)"
	@echo "   $(YELLOW)‚Ä¢ Prometheus:$(RESET) http://localhost:9090"
	@echo "   $(YELLOW)‚Ä¢ Grafana:$(RESET) http://localhost:3002 (admin/admin)"
	@echo "   $(YELLOW)‚Ä¢ Jaeger Tracing:$(RESET) http://localhost:16686"
	@echo "   $(YELLOW)‚Ä¢ InfluxDB:$(RESET) http://localhost:8086"

monitoring-full: ## Start complete monitoring infrastructure
	@echo "$(PURPLE)üìä Starting COMPLETE monitoring infrastructure...$(RESET)"
	@if [ -f ./scripts/fix-prometheus.sh ]; then \
		./scripts/fix-prometheus.sh setup; \
	elif [ -f docker-compose.monitoring.yml ]; then \
		docker-compose -f docker-compose.monitoring.yml up -d; \
		echo "$(GREEN)üöÄ Full monitoring stack started:$(RESET)"; \
		echo "   $(YELLOW)‚Ä¢ Prometheus:$(RESET) http://localhost:9090"; \
		echo "   $(YELLOW)‚Ä¢ Grafana:$(RESET) http://localhost:3002"; \
		echo "   $(YELLOW)‚Ä¢ Node Exporter:$(RESET) http://localhost:9100"; \
		echo "   $(YELLOW)‚Ä¢ cAdvisor:$(RESET) http://localhost:8080"; \
		echo "   $(YELLOW)‚Ä¢ Alertmanager:$(RESET) http://localhost:9093"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  monitoring files not found, using basic monitoring$(RESET)"; \
		$(MAKE) monitoring; \
	fi

fix-prometheus: ## Fix Prometheus configuration and setup
	@echo "$(BLUE)üîß Fixing Prometheus setup...$(RESET)"
	@if [ -f ./scripts/fix-prometheus.sh ]; then \
		./scripts/fix-prometheus.sh setup; \
	else \
		echo "$(RED)‚ùå fix-prometheus.sh script not found$(RESET)"; \
	fi

prometheus-start: ## Start Prometheus monitoring
	@./scripts/fix-prometheus.sh start

prometheus-stop: ## Stop Prometheus monitoring
	@./scripts/fix-prometheus.sh stop

prometheus-restart: ## Restart Prometheus monitoring
	@./scripts/fix-prometheus.sh restart

prometheus-status: ## Check Prometheus status
	@./scripts/fix-prometheus.sh status

prometheus-logs: ## Show Prometheus logs
	@./scripts/fix-prometheus.sh logs

prometheus-validate: ## Validate Prometheus setup
	@./scripts/fix-prometheus.sh validate

prometheus-clean: ## Clean Prometheus setup
	@./scripts/fix-prometheus.sh clean

# Status and Logs
status: ## Show service status
	@$(MAKE) show-status

show-status:
	@echo ""
	@echo "$(BLUE)üîç Service Status:$(RESET)"
	@echo "=================="
	@docker-compose -f docker-compose.dev.yml ps
	@echo ""
	@echo "$(GREEN)üåê Available Services:$(RESET)"
	@echo "   $(CYAN)‚Ä¢ Frontend:$(RESET) http://localhost:3000"
	@echo "   $(CYAN)‚Ä¢ Backend API:$(RESET) http://localhost:3001"
	@echo "   $(CYAN)‚Ä¢ Backend Health:$(RESET) http://localhost:3001/api/health"
	@echo "   $(CYAN)‚Ä¢ Enhanced Health:$(RESET) http://localhost:3001/api/health/comprehensive"
	@echo "   $(CYAN)‚Ä¢ Frontend Health:$(RESET) http://localhost:3000/api/health"
	@echo "   $(CYAN)‚Ä¢ Ollama API:$(RESET) http://localhost:11434"
	@echo "   $(CYAN)‚Ä¢ Redis:$(RESET) localhost:6379"

show-full-status:
	@$(MAKE) show-status
	@echo ""
	@echo "$(PURPLE)üåü Advanced Features Status:$(RESET)"
	@echo "================================="
	@if [ "$$ENABLE_VOICE_INTERFACE" = "true" ]; then echo "   $(GREEN)‚úÖ Voice Interface (6 languages)$(RESET)"; else echo "   $(YELLOW)‚ö™ Voice Interface$(RESET)"; fi
	@if [ "$$ENABLE_BLOCKCHAIN_AUDIT" = "true" ]; then echo "   $(GREEN)‚úÖ Blockchain Audit Trail$(RESET)"; else echo "   $(YELLOW)‚ö™ Blockchain Audit$(RESET)"; fi
	@if [ "$$ENABLE_COLLABORATION" = "true" ]; then echo "   $(GREEN)‚úÖ Real-time Collaboration$(RESET)"; else echo "   $(YELLOW)‚ö™ Collaboration$(RESET)"; fi
	@if [ "$$ENABLE_MONITORING" = "true" ]; then echo "   $(GREEN)‚úÖ Advanced Monitoring$(RESET)"; else echo "   $(YELLOW)‚ö™ Advanced Monitoring$(RESET)"; fi
	@if [ "$$MULTI_TENANT_MODE" = "true" ]; then echo "   $(GREEN)‚úÖ Multi-Tenant Architecture$(RESET)"; else echo "   $(YELLOW)‚ö™ Multi-Tenant$(RESET)"; fi

# Health Checks
health: ## Run comprehensive health checks for all services
	@echo "$(GREEN)üè• Running health checks...$(RESET)"
	@./scripts/statusline.sh --phase Test --msg "Running comprehensive health checks"
	@if [ -f ./scripts/health-check.sh ]; then \
		./scripts/health-check.sh; \
		./scripts/statusline.sh --ok "Health checks completed" --extras "script=comprehensive"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Health check script not found, running basic checks...$(RESET)"; \
		./scripts/statusline.sh --warn "Using basic health checks" --extras "script=basic comprehensive=unavailable"; \
		$(MAKE) health-basic; \
	fi

health-detailed: ## Run detailed health checks
	@echo "$(GREEN)üè• Running detailed health checks...$(RESET)"
	@if [ -f ./scripts/health-check-comprehensive.sh ]; then \
		./scripts/health-check-comprehensive.sh; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Comprehensive health check script not found$(RESET)"; \
		$(MAKE) health; \
	fi

health-basic: ## Basic health check using curl with detailed status
	@echo "$(BLUE)üîç Basic Health Checks:$(RESET)"
	@./scripts/statusline.sh --phase Test --msg "Testing service endpoints"
	@FRONTEND_STATUS=$$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3000/api/health 2>/dev/null || echo "DOWN"); \
	BACKEND_STATUS=$$(curl -s -o /dev/null -w "%{http_code}" http://localhost:3001/api/health 2>/dev/null || echo "DOWN"); \
	OLLAMA_STATUS=$$(curl -s -o /dev/null -w "%{http_code}" http://localhost:11434/api/version 2>/dev/null || echo "DOWN"); \
	echo "Frontend: $$FRONTEND_STATUS"; \
	echo "Backend: $$BACKEND_STATUS"; \
	echo "Ollama: $$OLLAMA_STATUS"; \
	if echo "$$FRONTEND_STATUS" | grep -q "^2[0-9][0-9]$$" && echo "$$BACKEND_STATUS" | grep -q "^2[0-9][0-9]$$" && echo "$$OLLAMA_STATUS" | grep -q "^2[0-9][0-9]$$"; then \
		./scripts/statusline.sh --ok "All services healthy" --extras "frontend=$$FRONTEND_STATUS backend=$$BACKEND_STATUS ollama=$$OLLAMA_STATUS"; \
	else \
		./scripts/statusline.sh --warn "Services not running (expected when containers are down)" --extras "frontend=$$FRONTEND_STATUS backend=$$BACKEND_STATUS ollama=$$OLLAMA_STATUS"; \
	fi

health-watch: ## Watch health status (updates every 5 seconds)
	@echo "$(BLUE)üëÄ Watching health status (Ctrl+C to stop)...$(RESET)"
	@if command -v watch >/dev/null 2>&1; then \
		watch -n 5 "$(MAKE) health-basic"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  'watch' command not found, running health check once$(RESET)"; \
		$(MAKE) health-basic; \
	fi

# Logging
logs: ## Show logs for all services
	@docker-compose -f docker-compose.dev.yml logs -f

logs-frontend: ## Show frontend logs
	@docker-compose -f docker-compose.dev.yml logs -f frontend

logs-backend: ## Show backend logs
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend "; then \
		docker-compose -f docker-compose.dev.yml logs -f backend; \
	else \
		docker-compose -f docker-compose.dev.yml logs -f backend-cpu; \
	fi

logs-ollama: ## Show Ollama logs
	@docker-compose -f docker-compose.dev.yml logs -f ollama ollama-cpu 2>/dev/null || \
	echo "$(YELLOW)‚ö†Ô∏è  Ollama containers not running$(RESET)"

logs-monitoring: ## Show monitoring logs
	@docker-compose --profile monitoring -f docker-compose.dev.yml logs -f

logs-follow: ## Follow logs with service names (specify SERVICE=name)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(BLUE)Available services:$(RESET) frontend, backend, ollama, redis, monitoring"; \
		echo "Usage: make logs-follow SERVICE=backend"; \
	else \
		docker-compose -f docker-compose.dev.yml logs -f $(SERVICE); \
	fi

# Testing
test: ## Run all tests
	@echo "$(GREEN)üß™ Running all tests...$(RESET)"
	@$(MAKE) test-backend
	@$(MAKE) test-frontend

test-backend: ## Run backend tests only
	@echo "$(BLUE)üß™ Running backend tests...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend "; then \
		docker-compose -f docker-compose.dev.yml exec backend npm test; \
	else \
		docker-compose -f docker-compose.dev.yml exec backend-cpu npm test; \
	fi

test-frontend: ## Run frontend tests only
	@echo "$(BLUE)üß™ Running frontend tests...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec frontend npm test

test-watch: ## Run tests in watch mode (specify SERVICE=backend or frontend)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)‚ùå Please specify SERVICE: make test-watch SERVICE=backend$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üß™ Running $(SERVICE) tests in watch mode...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec $(SERVICE) npm run test:watch

test-coverage: ## Run tests with coverage
	@echo "$(GREEN)üìä Running tests with coverage...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec backend npm run test:coverage
	@docker-compose -f docker-compose.dev.yml exec frontend npm run test:coverage

test-e2e: ## Run end-to-end tests
	@echo "$(PURPLE)üé≠ Running E2E tests...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "frontend.*Up"; then \
		docker-compose -f docker-compose.dev.yml exec frontend npm run test:e2e; \
	else \
		echo "$(RED)‚ùå Frontend not running. Start with 'make dev' first.$(RESET)"; \
	fi

# Database Management
db-reset: ## Reset development database
	@echo "$(YELLOW)üóÑÔ∏è Resetting database...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend"; then \
		docker-compose -f docker-compose.dev.yml exec backend rm -f /app/data/database.sqlite; \
		docker-compose -f docker-compose.dev.yml restart backend; \
		echo "$(GREEN)‚úÖ Database reset complete$(RESET)"; \
	else \
		echo "$(RED)‚ùå Backend not running$(RESET)"; \
	fi

db-backup: ## Backup development database
	@echo "$(BLUE)üíæ Backing up database...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend"; then \
		BACKUP_FILE="backup-$$(date +%Y%m%d-%H%M%S).sqlite"; \
		docker cp $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/data/database.sqlite ./$$BACKUP_FILE; \
		echo "$(GREEN)‚úÖ Database backed up to $$BACKUP_FILE$(RESET)"; \
	else \
		echo "$(RED)‚ùå Backend not running$(RESET)"; \
	fi

db-migrate: ## Run database migrations
	@echo "$(BLUE)üîÑ Running database migrations...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend"; then \
		docker-compose -f docker-compose.dev.yml exec backend npm run migrate; \
		echo "$(GREEN)‚úÖ Migrations complete$(RESET)"; \
	else \
		echo "$(RED)‚ùå Backend not running$(RESET)"; \
	fi

db-seed: ## Seed database with sample data
	@echo "$(BLUE)üå± Seeding database...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend"; then \
		docker-compose -f docker-compose.dev.yml exec backend npm run seed; \
		echo "$(GREEN)‚úÖ Database seeded$(RESET)"; \
	else \
		echo "$(RED)‚ùå Backend not running$(RESET)"; \
	fi

# Security
security-scan: ## Run security scans
	@echo "$(RED)üõ°Ô∏è Running security scans...$(RESET)"
	@if [ -f ./scripts/security-test.sh ]; then \
		./scripts/security-test.sh; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Security test script not found$(RESET)"; \
	fi

security-audit: ## Audit npm packages for vulnerabilities
	@echo "$(RED)üîç Auditing npm packages...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec backend npm audit
	@docker-compose -f docker-compose.dev.yml exec frontend npm audit

# Performance
benchmark: ## Run performance benchmarks
	@echo "$(PURPLE)‚ö° Running performance benchmarks...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend"; then \
		docker-compose -f docker-compose.dev.yml exec backend npm run benchmark; \
	else \
		echo "$(RED)‚ùå Backend not running$(RESET)"; \
	fi

load-test: ## Run load tests (requires backend running)
	@echo "$(PURPLE)üî• Running load tests...$(RESET)"
	@if command -v ab >/dev/null 2>&1; then \
		ab -n 1000 -c 10 http://localhost:3001/api/health; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Apache Bench (ab) not found. Install with: apt-get install apache2-utils$(RESET)"; \
	fi

# Cleanup
stop: ## Stop all services
	@echo "$(YELLOW)üõë Stopping development environment...$(RESET)"
	@docker-compose -f docker-compose.dev.yml down
	@if [ -f docker-compose.monitoring.yml ]; then \
		docker-compose -f docker-compose.monitoring.yml down; \
	fi

clean: ## Stop and remove all containers, networks, and volumes
	@echo "$(RED)üßπ Cleaning up development environment...$(RESET)"
	@docker-compose -f docker-compose.dev.yml down -v --remove-orphans
	@if [ -f docker-compose.monitoring.yml ]; then \
		docker-compose -f docker-compose.monitoring.yml down -v --remove-orphans; \
	fi
	@docker system prune -f
	@echo "$(GREEN)‚úÖ Cleanup complete$(RESET)"

clean-all: ## Deep clean including images and build cache
	@echo "$(RED)üî• Deep cleaning (including images)...$(RESET)"
	@$(MAKE) clean
	@docker image prune -a -f
	@docker builder prune -f
	@echo "$(GREEN)‚úÖ Deep clean complete$(RESET)"

# Restart Commands
restart: ## Restart all services
	@echo "$(BLUE)üîÑ Restarting development environment...$(RESET)"
	@$(MAKE) stop
	@sleep 2
	@$(MAKE) dev

restart-backend: ## Restart backend service only
	@echo "$(BLUE)üîÑ Restarting backend...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend "; then \
		docker-compose -f docker-compose.dev.yml restart backend; \
	else \
		docker-compose -f docker-compose.dev.yml restart backend-cpu; \
	fi

restart-frontend: ## Restart frontend service only
	@echo "$(BLUE)üîÑ Restarting frontend...$(RESET)"
	@docker-compose -f docker-compose.dev.yml restart frontend

restart-service: ## Restart specific service (specify SERVICE=name)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)‚ùå Please specify SERVICE: make restart-service SERVICE=backend$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üîÑ Restarting $(SERVICE)...$(RESET)"
	@docker-compose -f docker-compose.dev.yml restart $(SERVICE)

# Build Commands
build: ## Build all development images with validation
	@echo "$(PURPLE)üèóÔ∏è Building development images...$(RESET)"
	@./scripts/statusline.sh --phase Build --msg "Starting container build process"
	@if docker-compose -f docker-compose.dev.yml build; then \
		./scripts/statusline.sh --ok "All images built successfully" --extras "images=frontend,backend,ollama"; \
	else \
		./scripts/statusline.sh --error "Build failed" --extras "retry=available"; \
		exit 1; \
	fi

build-backend: ## Build backend image only with validation
	@echo "$(BLUE)üèóÔ∏è Building backend image...$(RESET)"
	@./scripts/statusline.sh --phase Build --msg "Building backend container"
	@if docker-compose -f docker-compose.dev.yml build backend; then \
		./scripts/statusline.sh --ok "Backend image built" --extras "size=$$(docker images prompt-card-system-v2-backend:latest --format 'table {{.Size}}' 2>/dev/null | tail -1)"; \
	else \
		./scripts/statusline.sh --error "Backend build failed" --extras "check=dockerfile,dependencies"; \
		exit 1; \
	fi

build-frontend: ## Build frontend image only with validation
	@echo "$(BLUE)üèóÔ∏è Building frontend image...$(RESET)"
	@./scripts/statusline.sh --phase Build --msg "Building frontend container"
	@if docker-compose -f docker-compose.dev.yml build frontend; then \
		./scripts/statusline.sh --ok "Frontend image built" --extras "size=$$(docker images prompt-card-system-v2-frontend:latest --format 'table {{.Size}}' 2>/dev/null | tail -1)"; \
	else \
		./scripts/statusline.sh --error "Frontend build failed" --extras "check=dockerfile,node_modules"; \
		exit 1; \
	fi

build-no-cache: ## Build all images without cache (clean build)
	@echo "$(PURPLE)üèóÔ∏è Building images without cache...$(RESET)"
	@./scripts/statusline.sh --phase Build --msg "Clean build without cache" --extras "cache=disabled"
	@if docker-compose -f docker-compose.dev.yml build --no-cache; then \
		./scripts/statusline.sh --ok "Clean build completed" --extras "cache=cleared images=rebuilt"; \
	else \
		./scripts/statusline.sh --error "Clean build failed" --extras "retry_with_cache=available"; \
		exit 1; \
	fi

# Shell Access
shell-backend: ## Open shell in backend container
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend "; then \
		docker-compose -f docker-compose.dev.yml exec backend sh; \
	else \
		docker-compose -f docker-compose.dev.yml exec backend-cpu sh; \
	fi

shell-frontend: ## Open shell in frontend container
	@docker-compose -f docker-compose.dev.yml exec frontend sh

shell-ollama: ## Open shell in Ollama container
	@docker-compose -f docker-compose.dev.yml exec ollama sh 2>/dev/null || \
	docker-compose -f docker-compose.dev.yml exec ollama-cpu sh 2>/dev/null || \
	echo "$(RED)‚ùå Ollama container not running$(RESET)"

shell-redis: ## Open Redis CLI
	@docker-compose -f docker-compose.dev.yml exec redis redis-cli

# Development Utilities
npm-install: ## Install npm dependencies (specify SERVICE=backend or frontend)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)‚ùå Please specify SERVICE: make npm-install SERVICE=backend$(RESET)"; \
		exit 1; \
	fi
	@echo "$(BLUE)üì¶ Installing npm dependencies for $(SERVICE)...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec $(SERVICE) npm install

npm-update: ## Update npm dependencies (specify SERVICE=backend or frontend)
	@if [ -z "$(SERVICE)" ]; then \
		echo "$(RED)‚ùå Please specify SERVICE: make npm-update SERVICE=backend$(RESET)"; \
		exit 1; \
	fi
	@echo "$(YELLOW)üîÑ Updating npm dependencies for $(SERVICE)...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec $(SERVICE) npm update

lint: ## Run linting for all services
	@echo "$(BLUE)üîç Running linting...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec backend npm run lint
	@docker-compose -f docker-compose.dev.yml exec frontend npm run lint

lint-fix: ## Fix linting issues
	@echo "$(YELLOW)üîß Fixing linting issues...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec backend npm run lint:fix
	@docker-compose -f docker-compose.dev.yml exec frontend npm run lint:fix

format: ## Format code with prettier
	@echo "$(BLUE)‚ú® Formatting code...$(RESET)"
	@docker-compose -f docker-compose.dev.yml exec backend npm run format
	@docker-compose -f docker-compose.dev.yml exec frontend npm run format

# Demo Mode Commands
demo-clean: ## Clean Docker networks and containers before demo
	@echo "$(BLUE)üßπ Cleaning Docker environment for demo...$(RESET)"
	@docker-compose -f docker-compose.dev.yml down --remove-orphans 2>/dev/null || true
	@if [ -f docker-compose.monitoring.yml ]; then docker-compose -f docker-compose.monitoring.yml down --remove-orphans 2>/dev/null || true; fi
	@docker network ls --filter name=prompt-card-system --format "{{.ID}}" | xargs -r docker network rm 2>/dev/null || true
	@docker network rm prompt-card-system-v2_prompt-card-network 2>/dev/null || true
	@docker network prune -f 2>/dev/null || true
	@docker container prune -f 2>/dev/null || true
	@echo "$(GREEN)‚úÖ Docker environment cleaned$(RESET)"

demo: ## Start demo mode with all features
	@echo "$(PURPLE)üéÆ Starting DEMO MODE - Full Feature Showcase$(RESET)"
	@echo "$(YELLOW)‚ú® Prepopulated with sample data and test cases$(RESET)"
	@$(MAKE) demo-clean
	@DEMO_MODE=true $(MAKE) dev
	@sleep 5
	@$(MAKE) demo-status

demo-quick: ## Quick demo setup (3-minute experience)
	@echo "$(CYAN)‚ö° Quick Demo Mode (3-minute experience)$(RESET)"
	@echo "$(YELLOW)üéØ Perfect for presentations and rapid demonstrations$(RESET)"
	@$(MAKE) demo-clean
	@DEMO_MODE=true DEMO_TYPE=quick $(MAKE) dev-minimal
	@sleep 3
	@$(MAKE) demo-load-data
	@$(MAKE) demo-status

demo-load-data: ## Load demo data into running system
	@echo "$(BLUE)üìä Loading demo data...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend.*Up"; then \
		echo "$(YELLOW)Loading 5 prompt cards with test cases...$(RESET)"; \
		docker cp demo/ $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/ 2>/dev/null || \
		( \
			docker-compose -f docker-compose.dev.yml exec backend mkdir -p /app/demo && \
			docker cp demo/demo-prompt-cards.json $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/demo/ && \
			docker cp demo/demo-test-cases.json $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/demo/ && \
			docker cp demo/demo-analytics.json $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/demo/ && \
			docker cp demo/demo-config.json $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/demo/ && \
			docker cp demo/load-demo-data.js $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/demo/ \
		); \
		docker-compose -f docker-compose.dev.yml exec backend node demo/load-demo-data.js || \
		echo "$(YELLOW)‚ö†Ô∏è  Demo data loader not available, continuing with static files$(RESET)"; \
		echo "$(GREEN)‚úÖ Demo data loaded successfully$(RESET)"; \
	else \
		echo "$(RED)‚ùå Backend not running. Start with 'make demo' first.$(RESET)"; \
	fi

demo-status: ## Show demo mode status and URLs
	@echo "$(GREEN)üéÆ DEMO MODE ACTIVE$(RESET)"
	@echo "======================"
	@echo "$(CYAN)üåê Demo URLs:$(RESET)"
	@echo "   ‚Ä¢ Main Demo: http://localhost:3000?demo=true"
	@echo "   ‚Ä¢ Quick Tour: http://localhost:3000?demo=quick-win"
	@echo "   ‚Ä¢ Full Tour: http://localhost:3000?demo=full-tour"
	@echo "   ‚Ä¢ Technical Demo: http://localhost:3000?demo=technical"
	@echo ""
	@echo "$(YELLOW)üìã Demo Features:$(RESET)"
	@echo "   ‚úÖ 5 Prepopulated prompt cards"
	@echo "   ‚úÖ 15+ Test cases with results"
	@echo "   ‚úÖ 30 days of analytics data"
	@echo "   ‚úÖ Team workspace with 5 members"
	@echo "   ‚úÖ Interactive guided tours"
	@echo "   ‚úÖ Success/failure examples"
	@echo ""
	@echo "$(PURPLE)üéØ Demo Scripts Available:$(RESET)"
	@echo "   ‚Ä¢ 3-minute quick demo"
	@echo "   ‚Ä¢ 5-minute full tour"
	@echo "   ‚Ä¢ 8-minute technical deep-dive"
	@echo ""
	@echo "$(BLUE)üìñ Demo Guide: ./demo/DEMO_QUICK_START.md$(RESET)"

demo-reset: ## Reset demo data to initial state
	@echo "$(YELLOW)üîÑ Resetting demo data...$(RESET)"
	@if docker-compose -f docker-compose.dev.yml ps | grep -q "backend.*Up"; then \
		docker-compose -f docker-compose.dev.yml exec backend rm -rf /app/demo/current-state.json; \
		$(MAKE) demo-load-data; \
		echo "$(GREEN)‚úÖ Demo data reset to initial state$(RESET)"; \
	else \
		echo "$(RED)‚ùå Backend not running$(RESET)"; \
	fi

demo-stop: ## Stop demo mode and return to development
	@echo "$(YELLOW)üõë Stopping demo mode...$(RESET)"
	@$(MAKE) stop
	@echo "$(GREEN)‚úÖ Demo mode stopped. Use 'make dev' for normal development.$(RESET)"

demo-export: ## Export demo session results
	@echo "$(BLUE)üìÅ Exporting demo session...$(RESET)"
	@TIMESTAMP=$$(date +%Y%m%d-%H%M%S); \
	mkdir -p exports/demo-$$TIMESTAMP; \
	cp -r demo/ exports/demo-$$TIMESTAMP/; \
	if docker-compose -f docker-compose.dev.yml ps | grep -q "backend.*Up"; then \
		docker cp $$(docker-compose -f docker-compose.dev.yml ps -q backend | head -1):/app/demo/session-data.json exports/demo-$$TIMESTAMP/ 2>/dev/null || true; \
	fi; \
	echo "$(GREEN)‚úÖ Demo session exported to exports/demo-$$TIMESTAMP/$(RESET)"

demo-presentation: ## Start demo in presentation mode (full screen, auto-advance)
	@echo "$(PURPLE)üé• Starting PRESENTATION MODE$(RESET)"
	@echo "$(YELLOW)üì∫ Optimized for live demonstrations and sales presentations$(RESET)"
	@$(MAKE) demo-clean
	@DEMO_MODE=true PRESENTATION_MODE=true $(MAKE) dev
	@sleep 5
	@echo "$(GREEN)üé¨ Presentation mode ready!$(RESET)"
	@echo "   ‚Ä¢ Auto-advancing slides"
	@echo "   ‚Ä¢ Larger text and UI elements"
	@echo "   ‚Ä¢ Simplified navigation"
	@echo "   ‚Ä¢ Focus on key metrics"

# Documentation
docs: ## Generate/serve documentation
	@echo "$(BLUE)üìö Documentation commands:$(RESET)"
	@echo "   ‚Ä¢ Main docs are in ./docs/"
	@echo "   ‚Ä¢ Demo guide: ./demo/DEMO_QUICK_START.md"
	@echo "   ‚Ä¢ API docs: http://localhost:3001/api/docs (when backend running)"
	@echo "   ‚Ä¢ README: ./README.md"

docs-api: ## Open API documentation
	@if command -v xdg-open >/dev/null 2>&1; then \
		xdg-open http://localhost:3001/api/docs; \
	elif command -v open >/dev/null 2>&1; then \
		open http://localhost:3001/api/docs; \
	else \
		echo "$(BLUE)üìñ API docs available at: http://localhost:3001/api/docs$(RESET)"; \
	fi

docs-demo: ## Open demo documentation
	@if command -v xdg-open >/dev/null 2>&1; then \
		xdg-open demo/DEMO_QUICK_START.md; \
	elif command -v open >/dev/null 2>&1; then \
		open demo/DEMO_QUICK_START.md; \
	else \
		echo "$(BLUE)üìñ Demo guide available at: ./demo/DEMO_QUICK_START.md$(RESET)"; \
	fi

# Production Preparation
prod-check: ## Check production readiness
	@echo "$(PURPLE)üöÄ Checking production readiness...$(RESET)"
	@$(MAKE) test
	@$(MAKE) security-audit
	@$(MAKE) lint
	@echo "$(GREEN)‚úÖ Production checks complete$(RESET)"

# Information Commands
info: ## Show system information
	@echo "$(BLUE)‚ÑπÔ∏è  System Information:$(RESET)"
	@echo "Docker version: $$(docker --version)"
	@echo "Docker Compose version: $$(docker-compose --version)"
	@echo "Node.js (host): $$(node --version 2>/dev/null || echo 'Not installed')"
	@echo "NPM (host): $$(npm --version 2>/dev/null || echo 'Not installed')"
	@echo "GPU Support: $$(nvidia-smi --version 2>/dev/null | head -1 || echo 'Not available')"
	@echo "Available Memory: $$(free -h 2>/dev/null | grep ^Mem || echo 'Unknown')"
	@echo "Disk Space: $$(df -h . 2>/dev/null | tail -1 || echo 'Unknown')"

urls: ## Show all service URLs
	@echo "$(GREEN)üåê Service URLs:$(RESET)"
	@echo "================================"
	@echo "$(CYAN)Development:$(RESET)"
	@echo "   ‚Ä¢ Frontend: http://localhost:3000"
	@echo "   ‚Ä¢ Backend API: http://localhost:3001"
	@echo "   ‚Ä¢ Health Check: http://localhost:3001/api/health"
	@echo ""
	@echo "$(YELLOW)Development Tools:$(RESET)"
	@echo "   ‚Ä¢ Adminer: http://localhost:8080"
	@echo "   ‚Ä¢ Redis Commander: http://localhost:8081"
	@echo ""
	@echo "$(PURPLE)Monitoring:$(RESET)"
	@echo "   ‚Ä¢ Prometheus: http://localhost:9090"
	@echo "   ‚Ä¢ Grafana: http://localhost:3002"
	@echo "   ‚Ä¢ Jaeger: http://localhost:16686"
	@echo ""
	@echo "$(BLUE)AI Services:$(RESET)"
	@echo "   ‚Ä¢ Ollama API: http://localhost:11434"

# Quick Development Workflows
quick-test: ## Quick test cycle (lint + test)
	@echo "$(GREEN)‚ö° Quick test cycle...$(RESET)"
	@$(MAKE) lint
	@$(MAKE) test

quick-fix: ## Quick fix cycle (format + lint-fix + test)
	@echo "$(YELLOW)üîß Quick fix cycle...$(RESET)"
	@$(MAKE) format
	@$(MAKE) lint-fix
	@$(MAKE) test

# Feature Demos
demo-voice: ## Demo Voice Interface features
	@echo "$(PURPLE)üé§ Voice Interface Demo:$(RESET)"
	@echo "1. Start with: make dev-voice"
	@echo "2. Visit: http://localhost:3000"
	@echo "3. Try voice commands like:"
	@echo "   ‚Ä¢ 'Create a new prompt for customer service'"
	@echo "   ‚Ä¢ 'Show me today's analytics'"
	@echo "   ‚Ä¢ 'Run the marketing test'"

demo-blockchain: ## Demo Blockchain Audit features
	@echo "$(BLUE)üîó Blockchain Audit Demo:$(RESET)"
	@echo "1. Start with: make dev-blockchain"
	@echo "2. Check audit trail: http://localhost:3001/api/blockchain/stats"
	@echo "3. All actions are automatically recorded on blockchain"

demo-collaboration: ## Demo Real-time Collaboration
	@echo "$(CYAN)ü§ù Collaboration Demo:$(RESET)"
	@echo "1. Start with: make dev-collaboration"
	@echo "2. Open multiple browser tabs"
	@echo "3. Edit prompts simultaneously and see real-time sync"

# Advanced Troubleshooting
debug: ## Start debug mode with verbose logging
	@echo "$(RED)üêõ Starting debug mode...$(RESET)"
	@DEBUG=* $(MAKE) dev

debug-backend: ## Debug backend with inspector
	@echo "$(RED)üêõ Backend debug mode (inspector on port 9229)...$(RESET)"
	@docker-compose -f docker-compose.dev.yml up -d backend
	@echo "$(YELLOW)Connect debugger to: localhost:9229$(RESET)"

debug-logs: ## Show debug logs with timestamps
	@docker-compose -f docker-compose.dev.yml logs -f --timestamps

troubleshoot: ## Run troubleshooting diagnostics
	@echo "$(YELLOW)üîß Running troubleshooting diagnostics...$(RESET)"
	@$(MAKE) info
	@echo ""
	@$(MAKE) health-basic
	@echo ""
	@echo "$(BLUE)Container Status:$(RESET)"
	@docker-compose -f docker-compose.dev.yml ps
	@echo ""
	@echo "$(BLUE)Recent Logs (last 20 lines):$(RESET)"
	@docker-compose -f docker-compose.dev.yml logs --tail=20

# Git Helpers
git-hooks: ## Install git hooks for development
	@echo "$(BLUE)üîó Installing git hooks...$(RESET)"
	@if [ -d .git ]; then \
		echo "#!/bin/sh\nmake lint-fix && make test" > .git/hooks/pre-commit; \
		chmod +x .git/hooks/pre-commit; \
		echo "$(GREEN)‚úÖ Pre-commit hook installed$(RESET)"; \
	else \
		echo "$(YELLOW)‚ö†Ô∏è  Not a git repository$(RESET)"; \
	fi

git-clean: ## Clean git ignored files (be careful!)
	@echo "$(RED)‚ö†Ô∏è  This will remove all git-ignored files$(RESET)"
	@read -p "Are you sure? (y/N): " confirm && [ "$$confirm" = "y" ] || exit 1
	@git clean -fdx

# Configuration
config-check: ## Check configuration files with statusline
	@echo "$(BLUE)‚öôÔ∏è  Checking configuration files...$(RESET)"
	@./scripts/statusline.sh --phase Setup --msg "Validating configuration files"
	@MISSING_FILES=""; \
	for file in .env .env.dev docker-compose.dev.yml; do \
		if [ -f "$$file" ]; then \
			echo "$(GREEN)‚úÖ $$file exists$(RESET)"; \
		else \
			echo "$(RED)‚ùå $$file missing$(RESET)"; \
			MISSING_FILES="$$MISSING_FILES $$file"; \
		fi; \
	done; \
	if [ -z "$$MISSING_FILES" ]; then \
		./scripts/statusline.sh --ok "All configuration files present" --extras "files=.env,.env.dev,docker-compose.dev.yml"; \
	else \
		./scripts/statusline.sh --error "Missing configuration files" --extras "missing=$$MISSING_FILES"; \
	fi

config-validate: ## Validate docker-compose configuration with detailed feedback
	@echo "$(BLUE)‚úÖ Validating docker-compose configuration...$(RESET)"
	@./scripts/statusline.sh --phase Test --msg "Validating Docker Compose syntax"
	@if docker-compose -f docker-compose.dev.yml config >/dev/null 2>&1; then \
		./scripts/statusline.sh --ok "Docker Compose configuration valid" --extras "file=docker-compose.dev.yml syntax=valid"; \
		echo "$(GREEN)‚úÖ Configuration valid$(RESET)"; \
	else \
		./scripts/statusline.sh --error "Docker Compose configuration invalid" --extras "file=docker-compose.dev.yml check=syntax"; \
		echo "$(RED)‚ùå Configuration invalid$(RESET)"; \
		exit 1; \
	fi

# Advanced Build Validation
build-validate: ## Validate build without actually building
	@echo "$(BLUE)üîç Validating build configuration...$(RESET)"
	@./scripts/statusline.sh --phase Build --msg "Pre-build validation"
	@$(MAKE) config-validate
	@if [ -f frontend/Dockerfile.dev ] && [ -f backend/Dockerfile.dev ]; then \
		./scripts/statusline.sh --ok "Dockerfiles found" --extras "frontend=‚úì backend=‚úì"; \
		echo "$(GREEN)‚úÖ Dockerfiles present$(RESET)"; \
	else \
		./scripts/statusline.sh --error "Missing Dockerfiles" --extras "check=frontend/Dockerfile.dev,backend/Dockerfile.dev"; \
		echo "$(RED)‚ùå Missing Dockerfiles$(RESET)"; \
		exit 1; \
	fi

build-retry: ## Retry failed builds with automatic recovery
	@echo "$(YELLOW)üîÑ Retrying build with recovery strategies...$(RESET)"
	@./scripts/statusline.sh --phase Build --msg "Attempting build recovery"
	@echo "$(BLUE)Step 1: Cleaning Docker cache...$(RESET)"
	@docker builder prune -f 2>/dev/null || true
	@echo "$(BLUE)Step 2: Pulling base images...$(RESET)"
	@docker pull node:18-alpine 2>/dev/null || true
	@docker pull ollama/ollama:latest 2>/dev/null || true
	@echo "$(BLUE)Step 3: Retry build...$(RESET)"
	@if $(MAKE) build; then \
		./scripts/statusline.sh --ok "Build recovery successful" --extras "strategy=cache-clean,base-pull"; \
	else \
		./scripts/statusline.sh --error "Build recovery failed" --extras "next=build-no-cache"; \
		echo "$(RED)Build still failing. Try: make build-no-cache$(RESET)"; \
		exit 1; \
	fi

build-status: ## Show build status and image information
	@echo "$(BLUE)üìä Build Status Information$(RESET)"
	@./scripts/statusline.sh --phase Info --msg "Collecting build status"
	@echo "$(CYAN)Docker Images:$(RESET)"
	@docker images | grep prompt-card-system-v2 || echo "No project images found"
	@echo ""
	@echo "$(CYAN)Container Status:$(RESET)"
	@docker-compose -f docker-compose.dev.yml ps 2>/dev/null || echo "No containers running"
	@echo ""
	@echo "$(CYAN)Docker System Info:$(RESET)"
	@docker system df 2>/dev/null || echo "Docker system info unavailable"
	@./scripts/statusline.sh --ok "Build status collected" --extras "images=listed containers=checked system=analyzed"

# Enhanced Testing with Statusline
test-all: ## Run comprehensive test suite with progress tracking
	@echo "$(GREEN)üß™ Running comprehensive test suite...$(RESET)"
	@./scripts/statusline.sh --phase Test --msg "Starting comprehensive test suite"
	@$(MAKE) lint && \
	$(MAKE) test-backend && \
	$(MAKE) test-frontend && \
	$(MAKE) test-e2e && \
	./scripts/statusline.sh --ok "All tests passed" --extras "lint=‚úì backend=‚úì frontend=‚úì e2e=‚úì" || \
	(./scripts/statusline.sh --error "Test suite failed" --extras "check=individual_test_logs"; exit 1)

# Production Readiness
prod-ready: ## Complete production readiness check
	@echo "$(PURPLE)üöÄ Production Readiness Assessment$(RESET)"
	@./scripts/statusline.sh --phase Test --msg "Assessing production readiness"
	@echo "$(BLUE)1. Configuration validation...$(RESET)"
	@$(MAKE) config-validate
	@echo "$(BLUE)2. Security audit...$(RESET)"
	@$(MAKE) security-audit
	@echo "$(BLUE)3. Test suite...$(RESET)"
	@$(MAKE) test-all
	@echo "$(BLUE)4. Build validation...$(RESET)"
	@$(MAKE) build-validate
	@echo "$(BLUE)5. Health checks...$(RESET)"
	@$(MAKE) health
	@./scripts/statusline.sh --ok "Production readiness confirmed" --extras "config=‚úì security=‚úì tests=‚úì build=‚úì health=‚úì"
	@echo "$(GREEN)‚úÖ Ready for production deployment!$(RESET)"

# Container Health and Recovery
containers-health: ## Detailed container health assessment
	@echo "$(GREEN)üè• Detailed Container Health Assessment$(RESET)"
	@./scripts/statusline.sh --phase Test --msg "Assessing container health"
	@echo "$(CYAN)Container Status:$(RESET)"
	@docker-compose -f docker-compose.dev.yml ps
	@echo ""
	@echo "$(CYAN)Container Logs (last 10 lines each):$(RESET)"
	@for service in frontend backend backend-cpu ollama ollama-cpu redis; do \
		if docker-compose -f docker-compose.dev.yml ps $$service 2>/dev/null | grep -q "Up"; then \
			echo "$(BLUE)--- $$service ---$(RESET)"; \
			docker-compose -f docker-compose.dev.yml logs --tail=10 $$service 2>/dev/null || echo "No logs available"; \
		fi; \
	done
	@echo ""
	@./scripts/statusline.sh --ok "Container health assessment completed" --extras "services=checked logs=analyzed"

containers-restart-unhealthy: ## Restart unhealthy containers
	@echo "$(YELLOW)üîÑ Restarting unhealthy containers...$(RESET)"
	@./scripts/statusline.sh --phase Deploy --msg "Restarting unhealthy containers"
	@RESTARTED=0; \
	for service in frontend backend backend-cpu ollama ollama-cpu redis; do \
		if docker-compose -f docker-compose.dev.yml ps $$service 2>/dev/null | grep -q "Exit\|unhealthy"; then \
			echo "$(YELLOW)Restarting $$service...$(RESET)"; \
			docker-compose -f docker-compose.dev.yml restart $$service; \
			RESTARTED=$$((RESTARTED + 1)); \
		fi; \
	done; \
	if [ $$RESTARTED -gt 0 ]; then \
		./scripts/statusline.sh --ok "Restarted $$RESTARTED unhealthy containers" --extras "count=$$RESTARTED"; \
	else \
		./scripts/statusline.sh --ok "No unhealthy containers found" --extras "all_healthy=true"; \
	fi