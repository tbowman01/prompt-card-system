{"version":3,"sources":["/workspaces/prompt-card-system/backend/src/tests/integration/analytics-integration.test.ts"],"sourcesContent":["import request from 'supertest';\nimport assert from 'assert';\nimport app from '../../server';\nimport { EventStore } from '../../services/analytics/EventStore';\nimport { AnalyticsEngine } from '../../services/analytics/AnalyticsEngine';\n\ndescribe('Analytics Dashboard Integration Tests', () => {\n  let eventStore: EventStore;\n  let analyticsEngine: AnalyticsEngine;\n  const testCardId = 'test-card-analytics-123';\n  const testSessionId = 'test-session-analytics-456';\n\n  beforeEach(async () => {\n    eventStore = EventStore.getInstance();\n    analyticsEngine = AnalyticsEngine.getInstance();\n    \n    // Initialize analytics with test data\n    await eventStore.recordEvent({\n      event_type: 'test_execution_start',\n      entity_id: testCardId,\n      entity_type: 'prompt_card',\n      data: {\n        testSessionId,\n        cardId: testCardId\n      },\n      timestamp: new Date(),\n      metadata: {\n        testType: 'integration',\n        userAgent: 'test-runner'\n      }\n    });\n  });\n\n  describe('Frontend-Backend Analytics Communication', () => {\n    it('should handle analytics data retrieval for dashboard', async () => {\n      const response = await request(app)\n        .get(`/api/analytics/dashboard/${testCardId}`)\n        .expect(200);\n\n      assert(response.body.success === true);\n      expect(response.body.data).toHaveProperty('metrics');\n      expect(response.body.data).toHaveProperty('performance');\n      expect(response.body.data).toHaveProperty('costAnalysis');\n      expect(response.body.data).toHaveProperty('timeSeriesData');\n    });\n\n    it('should handle real-time analytics updates', async () => {\n      // Record multiple events\n      await eventStore.recordEvent({\n        event_type: 'test_execution_complete',\n        entity_id: testCardId,\n        entity_type: 'prompt_card',\n        data: {\n          testSessionId,\n          cardId: testCardId,\n          duration: 1500,\n          success: true,\n          tokensUsed: 250,\n          cost: 0.025\n        },\n        timestamp: new Date()\n      });\n\n      await eventStore.recordEvent({\n        event_type: 'test_execution_complete',\n        entity_id: testCardId,\n        entity_type: 'prompt_card',\n        data: {\n          testSessionId: testSessionId + '-2',\n          cardId: testCardId,\n          duration: 2000,\n          success: false,\n          tokensUsed: 300,\n          cost: 0.030\n        },\n        timestamp: new Date()\n      });\n\n      // Test real-time metrics endpoint\n      const response = await request(app)\n        .get(`/api/analytics/metrics/real-time/${testCardId}`)\n        .expect(200);\n\n      assert(response.body.success === true);\n      expect(response.body.data).toHaveProperty('activeTests');\n      expect(response.body.data).toHaveProperty('recentCompletions');\n      expect(response.body.data).toHaveProperty('averageExecutionTime');\n    });\n  });\n\n  describe('Performance Analytics', () => {\n    it('should calculate and store performance metrics correctly', async () => {\n      // Record test execution with performance data\n      await eventStore.recordEvent({\n        event_type: 'test_execution_complete',\n        entity_id: testCardId,\n        entity_type: 'prompt_card',\n        data: {\n          testSessionId,\n          cardId: testCardId,\n          duration: 1500,\n          success: true,\n          tokensUsed: 250,\n          cost: 0.025,\n          model: 'gpt-4'\n        },\n        timestamp: new Date(),\n        metadata: {\n          promptLength: 120,\n          responseLength: 85,\n          cacheHit: false\n        }\n      });\n\n      // Get performance metrics\n      const response = await request(app)\n        .get(`/api/analytics/performance/${testCardId}`)\n        .expect(200);\n\n      assert(response.body.success === true);\n      expect(response.body.data).toHaveProperty('averageExecutionTime');\n      expect(response.body.data).toHaveProperty('successRate');\n      expect(response.body.data).toHaveProperty('tokenUsageStats');\n      expect(typeof response.body.data.averageExecutionTime).toBe('number');\n      expect(response.body.data.successRate).toBeGreaterThanOrEqual(0);\n      expect(response.body.data.successRate).toBeLessThanOrEqual(1);\n    });\n  });\n\n  describe('Cost Analytics', () => {\n    it('should track costs across multiple models correctly', async () => {\n      const executions = [\n        { model: 'gpt-4', tokens: 250, cost: 0.025 },\n        { model: 'gpt-3.5-turbo', tokens: 300, cost: 0.015 },\n        { model: 'claude-2', tokens: 200, cost: 0.020 }\n      ];\n\n      for (const exec of executions) {\n        await eventStore.recordEvent({\n          event_type: 'test_execution_complete',\n          entity_id: testCardId,\n          entity_type: 'prompt_card',\n          data: {\n            testSessionId: `cost-${exec.tokens}`,\n            cardId: testCardId,\n            tokensUsed: exec.tokens,\n            cost: exec.cost,\n            model: exec.model\n          },\n          timestamp: new Date()\n        });\n      }\n\n      // Get cost analytics\n      const response = await request(app)\n        .get(`/api/analytics/costs/${testCardId}`)\n        .expect(200);\n\n      assert(response.body.success === true);\n      expect(response.body.data).toHaveProperty('totalCost');\n      expect(response.body.data).toHaveProperty('costBreakdown');\n      expect(response.body.data.totalCost).toBeCloseTo(0.060, 3);\n    });\n  });\n});"],"names":["describe","eventStore","analyticsEngine","testCardId","testSessionId","beforeEach","EventStore","getInstance","AnalyticsEngine","recordEvent","event_type","entity_id","entity_type","data","cardId","timestamp","Date","metadata","testType","userAgent","it","response","request","app","get","expect","assert","body","success","toHaveProperty","duration","tokensUsed","cost","model","promptLength","responseLength","cacheHit","averageExecutionTime","toBe","successRate","toBeGreaterThanOrEqual","toBeLessThanOrEqual","executions","tokens","exec","totalCost","toBeCloseTo"],"mappings":"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"}