18afbdafe1ad5576cf0acd6bde2275a5
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.connectionPool = exports.db = void 0;
exports.initializeDatabase = initializeDatabase;
const better_sqlite3_1 = __importDefault(require("better-sqlite3"));
const path_1 = __importDefault(require("path"));
const fs_1 = __importDefault(require("fs"));
const DATABASE_PATH = process.env.DATABASE_PATH || path_1.default.join(__dirname, '../../data/database.sqlite');
const poolConfig = {
    maxConnections: parseInt(process.env.DB_MAX_CONNECTIONS || '5'),
    idleTimeout: parseInt(process.env.DB_IDLE_TIMEOUT || '30000'),
    retryAttempts: parseInt(process.env.DB_RETRY_ATTEMPTS || '3'),
    retryDelay: parseInt(process.env.DB_RETRY_DELAY || '1000')
};
// Connection pool implementation
class DatabaseConnectionPool {
    constructor(dbPath, config) {
        this.dbPath = dbPath;
        this.config = config;
        this.connections = [];
        this.availableConnections = [];
        this.busyConnections = new Set();
        this.initialized = false;
        this.retryCount = 0;
    }
    createConnection() {
        // Ensure data directory exists
        const dataDir = path_1.default.dirname(this.dbPath);
        if (!fs_1.default.existsSync(dataDir)) {
            fs_1.default.mkdirSync(dataDir, { recursive: true });
        }
        const connection = new better_sqlite3_1.default(this.dbPath, {
            verbose: process.env.NODE_ENV === 'development' ? console.log : undefined,
            timeout: 5000 // 5 second timeout
        });
        // Enable foreign keys and optimize for concurrent access
        connection.pragma('foreign_keys = ON');
        connection.pragma('journal_mode = WAL');
        connection.pragma('synchronous = NORMAL');
        connection.pragma('cache_size = 1000');
        connection.pragma('temp_store = memory');
        return connection;
    }
    async initializePool() {
        if (this.initialized)
            return;
        try {
            // Create initial connections
            for (let i = 0; i < this.config.maxConnections; i++) {
                const connection = this.createConnection();
                this.connections.push(connection);
                this.availableConnections.push(connection);
            }
            this.initialized = true;
            this.retryCount = 0;
            console.log(`Database connection pool initialized with ${this.config.maxConnections} connections`);
        }
        catch (error) {
            console.error('Failed to initialize database connection pool:', error);
            await this.retryConnection();
        }
    }
    async retryConnection() {
        if (this.retryCount >= this.config.retryAttempts) {
            throw new Error(`Failed to connect to database after ${this.config.retryAttempts} attempts`);
        }
        this.retryCount++;
        console.log(`Retrying database connection (attempt ${this.retryCount}/${this.config.retryAttempts})...`);
        await new Promise(resolve => setTimeout(resolve, this.config.retryDelay * this.retryCount));
        await this.initializePool();
    }
    async getConnection() {
        if (!this.initialized) {
            await this.initializePool();
        }
        if (this.availableConnections.length === 0) {
            // Wait for a connection to become available
            await new Promise(resolve => setTimeout(resolve, 10));
            return this.getConnection();
        }
        const connection = this.availableConnections.pop();
        this.busyConnections.add(connection);
        return connection;
    }
    releaseConnection(connection) {
        if (this.busyConnections.has(connection)) {
            this.busyConnections.delete(connection);
            this.availableConnections.push(connection);
        }
    }
    async withConnection(operation) {
        const connection = await this.getConnection();
        try {
            return await operation(connection);
        }
        finally {
            this.releaseConnection(connection);
        }
    }
    getStats() {
        return {
            total: this.connections.length,
            available: this.availableConnections.length,
            busy: this.busyConnections.size,
            initialized: this.initialized
        };
    }
    close() {
        this.connections.forEach(conn => {
            try {
                conn.close();
            }
            catch (error) {
                console.error('Error closing database connection:', error);
            }
        });
        this.connections = [];
        this.availableConnections = [];
        this.busyConnections.clear();
        this.initialized = false;
    }
}
// Create global connection pool
const connectionPool = new DatabaseConnectionPool(DATABASE_PATH, poolConfig);
exports.connectionPool = connectionPool;
// Export legacy db interface for backward compatibility
exports.db = {
    prepare: (sql) => {
        return {
            run: async (...params) => {
                return connectionPool.withConnection((conn) => {
                    const stmt = conn.prepare(sql);
                    return stmt.run(...params);
                });
            },
            get: async (...params) => {
                return connectionPool.withConnection((conn) => {
                    const stmt = conn.prepare(sql);
                    return stmt.get(...params);
                });
            },
            all: async (...params) => {
                return connectionPool.withConnection((conn) => {
                    const stmt = conn.prepare(sql);
                    return stmt.all(...params);
                });
            }
        };
    },
    exec: async (sql) => {
        return connectionPool.withConnection((conn) => {
            try {
                return conn.exec(sql);
            }
            catch (error) {
                throw error; // Ensure errors are properly propagated
            }
        });
    },
    pragma: async (pragma) => {
        return connectionPool.withConnection((conn) => conn.pragma(pragma));
    },
    close: () => connectionPool.close(),
    transaction: (operations) => {
        return connectionPool.withConnection((conn) => {
            const transaction = conn.transaction(operations);
            return transaction(conn);
        });
    },
    getStats: () => connectionPool.getStats()
};
// Initialize database tables
async function initializeDatabase() {
    console.log('Initializing database...');
    try {
        // Create prompt_cards table
        await exports.db.exec(`
      CREATE TABLE IF NOT EXISTS prompt_cards (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        title TEXT NOT NULL,
        description TEXT,
        prompt_template TEXT NOT NULL,
        variables TEXT DEFAULT '[]', -- JSON array of variable names
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);
        // Create test_cases table
        await exports.db.exec(`
      CREATE TABLE IF NOT EXISTS test_cases (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        prompt_card_id INTEGER NOT NULL,
        name TEXT NOT NULL,
        input_variables TEXT NOT NULL, -- JSON object
        expected_output TEXT,
        assertions TEXT DEFAULT '[]', -- JSON array of assertion objects
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (prompt_card_id) REFERENCES prompt_cards(id) ON DELETE CASCADE
      )
    `);
        // Create enhanced test_results table for Phase 4
        await exports.db.exec(`
      CREATE TABLE IF NOT EXISTS test_results (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        test_case_id INTEGER NOT NULL,
        execution_id TEXT NOT NULL,
        model TEXT NOT NULL,
        response TEXT NOT NULL,
        passed BOOLEAN NOT NULL,
        assertions TEXT DEFAULT '[]', -- JSON array of assertion results
        execution_time_ms INTEGER,
        error TEXT,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (test_case_id) REFERENCES test_cases(id) ON DELETE CASCADE
      )
    `);
        // Create test execution queue table
        await exports.db.exec(`
      CREATE TABLE IF NOT EXISTS test_execution_queue (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        execution_id TEXT UNIQUE NOT NULL,
        prompt_card_id INTEGER NOT NULL,
        test_case_ids TEXT NOT NULL, -- JSON array
        model TEXT NOT NULL,
        status TEXT DEFAULT 'pending', -- pending, running, completed, failed, cancelled
        priority INTEGER DEFAULT 0,
        configuration TEXT, -- JSON
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        started_at DATETIME,
        completed_at DATETIME,
        error_message TEXT,
        FOREIGN KEY (prompt_card_id) REFERENCES prompt_cards(id)
      )
    `);
        // Create assertion_types table for advanced assertion system
        await exports.db.exec(`
      CREATE TABLE IF NOT EXISTS assertion_types (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT UNIQUE NOT NULL,
        description TEXT NOT NULL,
        parameters TEXT NOT NULL, -- JSON
        examples TEXT NOT NULL, -- JSON
        validator_code TEXT NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      )
    `);
        // Create assertion execution stats table
        await exports.db.exec(`
      CREATE TABLE IF NOT EXISTS assertion_execution_stats (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        assertion_type TEXT NOT NULL,
        total_executions INTEGER DEFAULT 0,
        successful_executions INTEGER DEFAULT 0,
        failed_executions INTEGER DEFAULT 0,
        total_execution_time INTEGER DEFAULT 0,
        last_executed DATETIME DEFAULT CURRENT_TIMESTAMP,
        UNIQUE(assertion_type)
      )
    `);
        // Create indexes for better performance
        await exports.db.exec(`
      CREATE INDEX IF NOT EXISTS idx_prompt_cards_title ON prompt_cards(title);
      CREATE INDEX IF NOT EXISTS idx_test_cases_prompt_card_id ON test_cases(prompt_card_id);
      CREATE INDEX IF NOT EXISTS idx_test_results_test_case_id ON test_results(test_case_id);
      CREATE INDEX IF NOT EXISTS idx_test_results_execution_id ON test_results(execution_id);
      CREATE INDEX IF NOT EXISTS idx_test_queue_status ON test_execution_queue(status);
      CREATE INDEX IF NOT EXISTS idx_test_queue_priority ON test_execution_queue(priority DESC);
      CREATE INDEX IF NOT EXISTS idx_assertion_types_name ON assertion_types(name);
      CREATE INDEX IF NOT EXISTS idx_assertion_stats_type ON assertion_execution_stats(assertion_type);
    `);
        console.log('Database initialized successfully');
        return exports.db;
    }
    catch (error) {
        console.error('Error initializing database:', error);
        throw error;
    }
}
// Graceful shutdown
process.on('SIGINT', () => {
    console.log('Closing database connection...');
    exports.db.close();
    process.exit(0);
});
exports.default = exports.db;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL3dvcmtzcGFjZXMvcHJvbXB0LWNhcmQtc3lzdGVtL2JhY2tlbmQvc3JjL2RhdGFiYXNlL2Nvbm5lY3Rpb24udHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBa01BLGdEQWlIQztBQW5URCxvRUFBc0M7QUFDdEMsZ0RBQXdCO0FBQ3hCLDRDQUFvQjtBQUVwQixNQUFNLGFBQWEsR0FBRyxPQUFPLENBQUMsR0FBRyxDQUFDLGFBQWEsSUFBSSxjQUFJLENBQUMsSUFBSSxDQUFDLFNBQVMsRUFBRSw0QkFBNEIsQ0FBQyxDQUFDO0FBVXRHLE1BQU0sVUFBVSxHQUF5QjtJQUN2QyxjQUFjLEVBQUUsUUFBUSxDQUFDLE9BQU8sQ0FBQyxHQUFHLENBQUMsa0JBQWtCLElBQUksR0FBRyxDQUFDO0lBQy9ELFdBQVcsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxlQUFlLElBQUksT0FBTyxDQUFDO0lBQzdELGFBQWEsRUFBRSxRQUFRLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxpQkFBaUIsSUFBSSxHQUFHLENBQUM7SUFDN0QsVUFBVSxFQUFFLFFBQVEsQ0FBQyxPQUFPLENBQUMsR0FBRyxDQUFDLGNBQWMsSUFBSSxNQUFNLENBQUM7Q0FDM0QsQ0FBQztBQUVGLGlDQUFpQztBQUNqQyxNQUFNLHNCQUFzQjtJQU8xQixZQUFvQixNQUFjLEVBQVUsTUFBNEI7UUFBcEQsV0FBTSxHQUFOLE1BQU0sQ0FBUTtRQUFVLFdBQU0sR0FBTixNQUFNLENBQXNCO1FBTmhFLGdCQUFXLEdBQXdCLEVBQUUsQ0FBQztRQUN0Qyx5QkFBb0IsR0FBd0IsRUFBRSxDQUFDO1FBQy9DLG9CQUFlLEdBQTJCLElBQUksR0FBRyxFQUFFLENBQUM7UUFDcEQsZ0JBQVcsR0FBRyxLQUFLLENBQUM7UUFDcEIsZUFBVSxHQUFHLENBQUMsQ0FBQztJQUVvRCxDQUFDO0lBRXBFLGdCQUFnQjtRQUN0QiwrQkFBK0I7UUFDL0IsTUFBTSxPQUFPLEdBQUcsY0FBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLENBQUMsTUFBTSxDQUFD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QU8sQ0FBQyxHQUFHLENBQUMsbUNBQW1DLENBQUMsQ0FBQztRQUNqRCxPQUFPLFVBQUUsQ0FBQztJQUNaLENBQUM7SUFBQyxPQUFPLEtBQUssRUFBRSxDQUFDO1FBQ2YsT0FBTyxDQUFDLEtBQUssQ0FBQyw4QkFBOEIsRUFBRSxLQUFLLENBQUMsQ0FBQztRQUNyRCxNQUFNLEtBQUssQ0FBQztJQUNkLENBQUM7QUFDSCxDQUFDO0FBRUQsb0JBQW9CO0FBQ3BCLE9BQU8sQ0FBQyxFQUFFLENBQUMsUUFBUSxFQUFFLEdBQUcsRUFBRTtJQUN4QixPQUFPLENBQUMsR0FBRyxDQUFDLGdDQUFnQyxDQUFDLENBQUM7SUFDOUMsVUFBRSxDQUFDLEtBQUssRUFBRSxDQUFDO0lBQ1gsT0FBTyxDQUFDLElBQUksQ0FBQyxDQUFDLENBQUMsQ0FBQztBQUNsQixDQUFDLENBQUMsQ0FBQztBQUVILGtCQUFlLFVBQUUsQ0FBQyIsIm5hbWVzIjpbXSwic291cmNlcyI6WyIvd29ya3NwYWNlcy9wcm9tcHQtY2FyZC1zeXN0ZW0vYmFja2VuZC9zcmMvZGF0YWJhc2UvY29ubmVjdGlvbi50cyJdLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgRGF0YWJhc2UgZnJvbSAnYmV0dGVyLXNxbGl0ZTMnO1xuaW1wb3J0IHBhdGggZnJvbSAncGF0aCc7XG5pbXBvcnQgZnMgZnJvbSAnZnMnO1xuXG5jb25zdCBEQVRBQkFTRV9QQVRIID0gcHJvY2Vzcy5lbnYuREFUQUJBU0VfUEFUSCB8fCBwYXRoLmpvaW4oX19kaXJuYW1lLCAnLi4vLi4vZGF0YS9kYXRhYmFzZS5zcWxpdGUnKTtcblxuLy8gQ29ubmVjdGlvbiBwb29sIGNvbmZpZ3VyYXRpb25cbmludGVyZmFjZSBDb25uZWN0aW9uUG9vbENvbmZpZyB7XG4gIG1heENvbm5lY3Rpb25zOiBudW1iZXI7XG4gIGlkbGVUaW1lb3V0OiBudW1iZXI7XG4gIHJldHJ5QXR0ZW1wdHM6IG51bWJlcjtcbiAgcmV0cnlEZWxheTogbnVtYmVyO1xufVxuXG5jb25zdCBwb29sQ29uZmlnOiBDb25uZWN0aW9uUG9vbENvbmZpZyA9IHtcbiAgbWF4Q29ubmVjdGlvbnM6IHBhcnNlSW50KHByb2Nlc3MuZW52LkRCX01BWF9DT05ORUNUSU9OUyB8fCAnNScpLFxuICBpZGxlVGltZW91dDogcGFyc2VJbnQocHJvY2Vzcy5lbnYuREJfSURMRV9USU1FT1VUIHx8ICczMDAwMCcpLFxuICByZXRyeUF0dGVtcHRzOiBwYXJzZUludChwcm9jZXNzLmVudi5EQl9SRVRSWV9BVFRFTVBUUyB8fCAnMycpLFxuICByZXRyeURlbGF5OiBwYXJzZUludChwcm9jZXNzLmVudi5EQl9SRVRSWV9ERUxBWSB8fCAnMTAwMCcpXG59O1xuXG4vLyBDb25uZWN0aW9uIHBvb2wgaW1wbGVtZW50YXRpb25cbmNsYXNzIERhdGFiYXNlQ29ubmVjdGlvblBvb2wge1xuICBwcml2YXRlIGNvbm5lY3Rpb25zOiBEYXRhYmFzZS5EYXRhYmFzZVtdID0gW107XG4gIHByaXZhdGUgYXZhaWxhYmxlQ29ubmVjdGlvbnM6IERhdGFiYXNlLkRhdGFiYXNlW10gPSBbXTtcbiAgcHJpdmF0ZSBidXN5Q29ubmVjdGlvbnM6IFNldDxEYXRhYmFzZS5EYXRhYmFzZT4gPSBuZXcgU2V0KCk7XG4gIHByaXZhdGUgaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgcHJpdmF0ZSByZXRyeUNvdW50ID0gMDtcblxuICBjb25zdHJ1Y3Rvcihwcml2YXRlIGRiUGF0aDogc3RyaW5nLCBwcml2YXRlIGNvbmZpZzogQ29ubmVjdGlvblBvb2xDb25maWcpIHt9XG5cbiAgcHJpdmF0ZSBjcmVhdGVDb25uZWN0aW9uKCk6IERhdGFiYXNlLkRhdGFiYXNlIHtcbiAgICAvLyBFbnN1cmUgZGF0YSBkaXJlY3RvcnkgZXhpc3RzXG4gICAgY29uc3QgZGF0YURpciA9IHBhdGguZGlybmFtZSh0aGlzLmRiUGF0aCk7XG4gICAgaWYgKCFmcy5leGlzdHNTeW5jKGRhdGFEaXIpKSB7XG4gICAgICBmcy5ta2RpclN5bmMoZGF0YURpciwgeyByZWN1cnNpdmU6IHRydWUgfSk7XG4gICAgfVxuXG4gICAgY29uc3QgY29ubmVjdGlvbiA9IG5ldyBEYXRhYmFzZSh0aGlzLmRiUGF0aCwge1xuICAgICAgdmVyYm9zZTogcHJvY2Vzcy5lbnYuTk9ERV9FTlYgPT09ICdkZXZlbG9wbWVudCcgPyBjb25zb2xlLmxvZyA6IHVuZGVmaW5lZCxcbiAgICAgIHRpbWVvdXQ6IDUwMDAgLy8gNSBzZWNvbmQgdGltZW91dFxuICAgIH0pO1xuXG4gICAgLy8gRW5hYmxlIGZvcmVpZ24ga2V5cyBhbmQgb3B0aW1pemUgZm9yIGNvbmN1cnJlbnQgYWNjZXNzXG4gICAgY29ubmVjdGlvbi5wcmFnbWEoJ2ZvcmVpZ25fa2V5cyA9IE9OJyk7XG4gICAgY29ubmVjdGlvbi5wcmFnbWEoJ2pvdXJuYWxfbW9kZSA9IFdBTCcpO1xuICAgIGNvbm5lY3Rpb24ucHJhZ21hKCdzeW5jaHJvbm91cyA9IE5PUk1BTCcpO1xuICAgIGNvbm5lY3Rpb24ucHJhZ21hKCdjYWNoZV9zaXplID0gMTAwMCcpO1xuICAgIGNvbm5lY3Rpb24ucHJhZ21hKCd0ZW1wX3N0b3JlID0gbWVtb3J5Jyk7XG4gICAgXG4gICAgcmV0dXJuIGNvbm5lY3Rpb247XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIGluaXRpYWxpemVQb29sKCk6IFByb21pc2U8dm9pZD4ge1xuICAgIGlmICh0aGlzLmluaXRpYWxpemVkKSByZXR1cm47XG5cbiAgICB0cnkge1xuICAgICAgLy8gQ3JlYXRlIGluaXRpYWwgY29ubmVjdGlvbnNcbiAgICAgIGZvciAobGV0IGkgPSAwOyBpIDwgdGhpcy5jb25maWcubWF4Q29ubmVjdGlvbnM7IGkrKykge1xuICAgICAgICBjb25zdCBjb25uZWN0aW9uID0gdGhpcy5jcmVhdGVDb25uZWN0aW9uKCk7XG4gICAgICAgIHRoaXMuY29ubmVjdGlvbnMucHVzaChjb25uZWN0aW9uKTtcbiAgICAgICAgdGhpcy5hdmFpbGFibGVDb25uZWN0aW9ucy5wdXNoKGNvbm5lY3Rpb24pO1xuICAgICAgfVxuICAgICAgXG4gICAgICB0aGlzLmluaXRpYWxpemVkID0gdHJ1ZTtcbiAgICAgIHRoaXMucmV0cnlDb3VudCA9IDA7XG4gICAgICBjb25zb2xlLmxvZyhgRGF0YWJhc2UgY29ubmVjdGlvbiBwb29sIGluaXRpYWxpemVkIHdpdGggJHt0aGlzLmNvbmZpZy5tYXhDb25uZWN0aW9uc30gY29ubmVjdGlvbnNgKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgY29uc29sZS5lcnJvcignRmFpbGVkIHRvIGluaXRpYWxpemUgZGF0YWJhc2UgY29ubmVjdGlvbiBwb29sOicsIGVycm9yKTtcbiAgICAgIGF3YWl0IHRoaXMucmV0cnlDb25uZWN0aW9uKCk7XG4gICAgfVxuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyByZXRyeUNvbm5lY3Rpb24oKTogUHJvbWlzZTx2b2lkPiB7XG4gICAgaWYgKHRoaXMucmV0cnlDb3VudCA+PSB0aGlzLmNvbmZpZy5yZXRyeUF0dGVtcHRzKSB7XG4gICAgICB0aHJvdyBuZXcgRXJyb3IoYEZhaWxlZCB0byBjb25uZWN0IHRvIGRhdGFiYXNlIGFmdGVyICR7dGhpcy5jb25maWcucmV0cnlBdHRlbXB0c30gYXR0ZW1wdHNgKTtcbiAgICB9XG5cbiAgICB0aGlzLnJldHJ5Q291bnQrKztcbiAgICBjb25zb2xlLmxvZyhgUmV0cnlpbmcgZGF0YWJhc2UgY29ubmVjdGlvbiAoYXR0ZW1wdCAke3RoaXMucmV0cnlDb3VudH0vJHt0aGlzLmNvbmZpZy5yZXRyeUF0dGVtcHRzfSkuLi5gKTtcbiAgICBcbiAgICBhd2FpdCBuZXcgUHJvbWlzZShyZXNvbHZlID0+IHNldFRpbWVvdXQocmVzb2x2ZSwgdGhpcy5jb25maWcucmV0cnlEZWxheSAqIHRoaXMucmV0cnlDb3VudCkpO1xuICAgIGF3YWl0IHRoaXMuaW5pdGlhbGl6ZVBvb2woKTtcbiAgfVxuXG4gIGFzeW5jIGdldENvbm5lY3Rpb24oKTogUHJvbWlzZTxEYXRhYmFzZS5EYXRhYmFzZT4ge1xuICAgIGlmICghdGhpcy5pbml0aWFsaXplZCkge1xuICAgICAgYXdhaXQgdGhpcy5pbml0aWFsaXplUG9vbCgpO1xuICAgIH1cblxuICAgIGlmICh0aGlzLmF2YWlsYWJsZUNvbm5lY3Rpb25zLmxlbmd0aCA9PT0gMCkge1xuICAgICAgLy8gV2FpdCBmb3IgYSBjb25uZWN0aW9uIHRvIGJlY29tZSBhdmFpbGFibGVcbiAgICAgIGF3YWl0IG5ldyBQcm9taXNlKHJlc29sdmUgPT4gc2V0VGltZW91dChyZXNvbHZlLCAxMCkpO1xuICAgICAgcmV0dXJuIHRoaXMuZ2V0Q29ubmVjdGlvbigpO1xuICAgIH1cblxuICAgIGNvbnN0IGNvbm5lY3Rpb24gPSB0aGlzLmF2YWlsYWJsZUNvbm5lY3Rpb25zLnBvcCgpITtcbiAgICB0aGlzLmJ1c3lDb25uZWN0aW9ucy5hZGQoY29ubmVjdGlvbik7XG4gICAgcmV0dXJuIGNvbm5lY3Rpb247XG4gIH1cblxuICByZWxlYXNlQ29ubmVjdGlvbihjb25uZWN0aW9uOiBEYXRhYmFzZS5EYXRhYmFzZSk6IHZvaWQge1xuICAgIGlmICh0aGlzLmJ1c3lDb25uZWN0aW9ucy5oYXMoY29ubmVjdGlvbikpIHtcbiAgICAgIHRoaXMuYnVzeUNvbm5lY3Rpb25zLmRlbGV0ZShjb25uZWN0aW9uKTtcbiAgICAgIHRoaXMuYXZhaWxhYmxlQ29ubmVjdGlvbnMucHVzaChjb25uZWN0aW9uKTtcbiAgICB9XG4gIH1cblxuICBhc3luYyB3aXRoQ29ubmVjdGlvbjxUPihvcGVyYXRpb246IChkYjogRGF0YWJhc2UuRGF0YWJhc2UpID0+IFByb21pc2U8VD4gfCBUKTogUHJvbWlzZTxUPiB7XG4gICAgY29uc3QgY29ubmVjdGlvbiA9IGF3YWl0IHRoaXMuZ2V0Q29ubmVjdGlvbigpO1xuICAgIHRyeSB7XG4gICAgICByZXR1cm4gYXdhaXQgb3BlcmF0aW9uKGNvbm5lY3Rpb24pO1xuICAgIH0gZmluYWxseSB7XG4gICAgICB0aGlzLnJlbGVhc2VDb25uZWN0aW9uKGNvbm5lY3Rpb24pO1xuICAgIH1cbiAgfVxuXG4gIGdldFN0YXRzKCkge1xuICAgIHJldHVybiB7XG4gICAgICB0b3RhbDogdGhpcy5jb25uZWN0aW9ucy5sZW5ndGgsXG4gICAgICBhdmFpbGFibGU6IHRoaXMuYXZhaWxhYmxlQ29ubmVjdGlvbnMubGVuZ3RoLFxuICAgICAgYnVzeTogdGhpcy5idXN5Q29ubmVjdGlvbnMuc2l6ZSxcbiAgICAgIGluaXRpYWxpemVkOiB0aGlzLmluaXRpYWxpemVkXG4gICAgfTtcbiAgfVxuXG4gIGNsb3NlKCk6IHZvaWQge1xuICAgIHRoaXMuY29ubmVjdGlvbnMuZm9yRWFjaChjb25uID0+IHtcbiAgICAgIHRyeSB7XG4gICAgICAgIGNvbm4uY2xvc2UoKTtcbiAgICAgIH0gY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgIGNvbnNvbGUuZXJyb3IoJ0Vycm9yIGNsb3NpbmcgZGF0YWJhc2UgY29ubmVjdGlvbjonLCBlcnJvcik7XG4gICAgICB9XG4gICAgfSk7XG4gICAgdGhpcy5jb25uZWN0aW9ucyA9IFtdO1xuICAgIHRoaXMuYXZhaWxhYmxlQ29ubmVjdGlvbnMgPSBbXTtcbiAgICB0aGlzLmJ1c3lDb25uZWN0aW9ucy5jbGVhcigpO1xuICAgIHRoaXMuaW5pdGlhbGl6ZWQgPSBmYWxzZTtcbiAgfVxufVxuXG4vLyBDcmVhdGUgZ2xvYmFsIGNvbm5lY3Rpb24gcG9vbFxuY29uc3QgY29ubmVjdGlvblBvb2wgPSBuZXcgRGF0YWJhc2VDb25uZWN0aW9uUG9vbChEQVRBQkFTRV9QQVRILCBwb29sQ29uZmlnKTtcblxuLy8gRXhwb3J0IGxlZ2FjeSBkYiBpbnRlcmZhY2UgZm9yIGJhY2t3YXJkIGNvbXBhdGliaWxpdHlcbmV4cG9ydCBjb25zdCBkYjogYW55ID0ge1xuICBwcmVwYXJlOiAoc3FsOiBzdHJpbmcpID0+IHtcbiAgICByZXR1cm4ge1xuICAgICAgcnVuOiBhc3luYyAoLi4ucGFyYW1zOiBhbnlbXSkgPT4ge1xuICAgICAgICByZXR1cm4gY29ubmVjdGlvblBvb2wud2l0aENvbm5lY3Rpb24oKGNvbm4pID0+IHtcbiAgICAgICAgICBjb25zdCBzdG10ID0gY29ubi5wcmVwYXJlKHNxbCk7XG4gICAgICAgICAgcmV0dXJuIHN0bXQucnVuKC4uLnBhcmFtcyk7XG4gICAgICAgIH0pO1xuICAgICAgfSxcbiAgICAgIGdldDogYXN5bmMgKC4uLnBhcmFtczogYW55W10pID0+IHtcbiAgICAgICAgcmV0dXJuIGNvbm5lY3Rpb25Qb29sLndpdGhDb25uZWN0aW9uKChjb25uKSA9PiB7XG4gICAgICAgICAgY29uc3Qgc3RtdCA9IGNvbm4ucHJlcGFyZShzcWwpO1xuICAgICAgICAgIHJldHVybiBzdG10LmdldCguLi5wYXJhbXMpO1xuICAgICAgICB9KTtcbiAgICAgIH0sXG4gICAgICBhbGw6IGFzeW5jICguLi5wYXJhbXM6IGFueVtdKSA9PiB7XG4gICAgICAgIHJldHVybiBjb25uZWN0aW9uUG9vbC53aXRoQ29ubmVjdGlvbigoY29ubikgPT4ge1xuICAgICAgICAgIGNvbnN0IHN0bXQgPSBjb25uLnByZXBhcmUoc3FsKTtcbiAgICAgICAgICByZXR1cm4gc3RtdC5hbGwoLi4ucGFyYW1zKTtcbiAgICAgICAgfSk7XG4gICAgICB9XG4gICAgfTtcbiAgfSxcbiAgZXhlYzogYXN5bmMgKHNxbDogc3RyaW5nKSA9PiB7XG4gICAgcmV0dXJuIGNvbm5lY3Rpb25Qb29sLndpdGhDb25uZWN0aW9uKChjb25uKSA9PiB7XG4gICAgICB0cnkge1xuICAgICAgICByZXR1cm4gY29ubi5leGVjKHNxbCk7XG4gICAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgICB0aHJvdyBlcnJvcjsgLy8gRW5zdXJlIGVycm9ycyBhcmUgcHJvcGVybHkgcHJvcGFnYXRlZFxuICAgICAgfVxuICAgIH0pO1xuICB9LFxuICBwcmFnbWE6IGFzeW5jIChwcmFnbWE6IHN0cmluZykgPT4ge1xuICAgIHJldHVybiBjb25uZWN0aW9uUG9vbC53aXRoQ29ubmVjdGlvbigoY29ubikgPT4gY29ubi5wcmFnbWEocHJhZ21hKSk7XG4gIH0sXG4gIGNsb3NlOiAoKSA9PiBjb25uZWN0aW9uUG9vbC5jbG9zZSgpLFxuICB0cmFuc2FjdGlvbjogKG9wZXJhdGlvbnM6IChkYjogRGF0YWJhc2UuRGF0YWJhc2UpID0+IGFueSkgPT4ge1xuICAgIHJldHVybiBjb25uZWN0aW9uUG9vbC53aXRoQ29ubmVjdGlvbigoY29ubikgPT4ge1xuICAgICAgY29uc3QgdHJhbnNhY3Rpb24gPSBjb25uLnRyYW5zYWN0aW9uKG9wZXJhdGlvbnMpO1xuICAgICAgcmV0dXJuIHRyYW5zYWN0aW9uKGNvbm4pO1xuICAgIH0pO1xuICB9LFxuICBnZXRTdGF0czogKCkgPT4gY29ubmVjdGlvblBvb2wuZ2V0U3RhdHMoKVxufTtcblxuLy8gRXhwb3J0IGNvbm5lY3Rpb24gcG9vbCBmb3IgYWR2YW5jZWQgdXNhZ2VcbmV4cG9ydCB7IGNvbm5lY3Rpb25Qb29sIH07XG5cbi8vIEluaXRpYWxpemUgZGF0YWJhc2UgdGFibGVzXG5leHBvcnQgYXN5bmMgZnVuY3Rpb24gaW5pdGlhbGl6ZURhdGFiYXNlKCk6IFByb21pc2U8YW55PiB7XG4gIGNvbnNvbGUubG9nKCdJbml0aWFsaXppbmcgZGF0YWJhc2UuLi4nKTtcbiAgXG4gIHRyeSB7XG4gICAgLy8gQ3JlYXRlIHByb21wdF9jYXJkcyB0YWJsZVxuICAgIGF3YWl0IGRiLmV4ZWMoYFxuICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgcHJvbXB0X2NhcmRzIChcbiAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULFxuICAgICAgICB0aXRsZSBURVhUIE5PVCBOVUxMLFxuICAgICAgICBkZXNjcmlwdGlvbiBURVhULFxuICAgICAgICBwcm9tcHRfdGVtcGxhdGUgVEVYVCBOT1QgTlVMTCxcbiAgICAgICAgdmFyaWFibGVzIFRFWFQgREVGQVVMVCAnW10nLCAtLSBKU09OIGFycmF5IG9mIHZhcmlhYmxlIG5hbWVzXG4gICAgICAgIGNyZWF0ZWRfYXQgREFURVRJTUUgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUCxcbiAgICAgICAgdXBkYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QXG4gICAgICApXG4gICAgYCk7XG5cbiAgICAvLyBDcmVhdGUgdGVzdF9jYXNlcyB0YWJsZVxuICAgIGF3YWl0IGRiLmV4ZWMoYFxuICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdGVzdF9jYXNlcyAoXG4gICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCxcbiAgICAgICAgcHJvbXB0X2NhcmRfaWQgSU5URUdFUiBOT1QgTlVMTCxcbiAgICAgICAgbmFtZSBURVhUIE5PVCBOVUxMLFxuICAgICAgICBpbnB1dF92YXJpYWJsZXMgVEVYVCBOT1QgTlVMTCwgLS0gSlNPTiBvYmplY3RcbiAgICAgICAgZXhwZWN0ZWRfb3V0cHV0IFRFWFQsXG4gICAgICAgIGFzc2VydGlvbnMgVEVYVCBERUZBVUxUICdbXScsIC0tIEpTT04gYXJyYXkgb2YgYXNzZXJ0aW9uIG9iamVjdHNcbiAgICAgICAgY3JlYXRlZF9hdCBEQVRFVElNRSBERUZBVUxUIENVUlJFTlRfVElNRVNUQU1QLFxuICAgICAgICBGT1JFSUdOIEtFWSAocHJvbXB0X2NhcmRfaWQpIFJFRkVSRU5DRVMgcHJvbXB0X2NhcmRzKGlkKSBPTiBERUxFVEUgQ0FTQ0FERVxuICAgICAgKVxuICAgIGApO1xuXG4gICAgLy8gQ3JlYXRlIGVuaGFuY2VkIHRlc3RfcmVzdWx0cyB0YWJsZSBmb3IgUGhhc2UgNFxuICAgIGF3YWl0IGRiLmV4ZWMoYFxuICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgdGVzdF9yZXN1bHRzIChcbiAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULFxuICAgICAgICB0ZXN0X2Nhc2VfaWQgSU5URUdFUiBOT1QgTlVMTCxcbiAgICAgICAgZXhlY3V0aW9uX2lkIFRFWFQgTk9UIE5VTEwsXG4gICAgICAgIG1vZGVsIFRFWFQgTk9UIE5VTEwsXG4gICAgICAgIHJlc3BvbnNlIFRFWFQgTk9UIE5VTEwsXG4gICAgICAgIHBhc3NlZCBCT09MRUFOIE5PVCBOVUxMLFxuICAgICAgICBhc3NlcnRpb25zIFRFWFQgREVGQVVMVCAnW10nLCAtLSBKU09OIGFycmF5IG9mIGFzc2VydGlvbiByZXN1bHRzXG4gICAgICAgIGV4ZWN1dGlvbl90aW1lX21zIElOVEVHRVIsXG4gICAgICAgIGVycm9yIFRFWFQsXG4gICAgICAgIGNyZWF0ZWRfYXQgREFURVRJTUUgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUCxcbiAgICAgICAgRk9SRUlHTiBLRVkgKHRlc3RfY2FzZV9pZCkgUkVGRVJFTkNFUyB0ZXN0X2Nhc2VzKGlkKSBPTiBERUxFVEUgQ0FTQ0FERVxuICAgICAgKVxuICAgIGApO1xuXG4gICAgLy8gQ3JlYXRlIHRlc3QgZXhlY3V0aW9uIHF1ZXVlIHRhYmxlXG4gICAgYXdhaXQgZGIuZXhlYyhgXG4gICAgICBDUkVBVEUgVEFCTEUgSUYgTk9UIEVYSVNUUyB0ZXN0X2V4ZWN1dGlvbl9xdWV1ZSAoXG4gICAgICAgIGlkIElOVEVHRVIgUFJJTUFSWSBLRVkgQVVUT0lOQ1JFTUVOVCxcbiAgICAgICAgZXhlY3V0aW9uX2lkIFRFWFQgVU5JUVVFIE5PVCBOVUxMLFxuICAgICAgICBwcm9tcHRfY2FyZF9pZCBJTlRFR0VSIE5PVCBOVUxMLFxuICAgICAgICB0ZXN0X2Nhc2VfaWRzIFRFWFQgTk9UIE5VTEwsIC0tIEpTT04gYXJyYXlcbiAgICAgICAgbW9kZWwgVEVYVCBOT1QgTlVMTCxcbiAgICAgICAgc3RhdHVzIFRFWFQgREVGQVVMVCAncGVuZGluZycsIC0tIHBlbmRpbmcsIHJ1bm5pbmcsIGNvbXBsZXRlZCwgZmFpbGVkLCBjYW5jZWxsZWRcbiAgICAgICAgcHJpb3JpdHkgSU5URUdFUiBERUZBVUxUIDAsXG4gICAgICAgIGNvbmZpZ3VyYXRpb24gVEVYVCwgLS0gSlNPTlxuICAgICAgICBjcmVhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICAgIHN0YXJ0ZWRfYXQgREFURVRJTUUsXG4gICAgICAgIGNvbXBsZXRlZF9hdCBEQVRFVElNRSxcbiAgICAgICAgZXJyb3JfbWVzc2FnZSBURVhULFxuICAgICAgICBGT1JFSUdOIEtFWSAocHJvbXB0X2NhcmRfaWQpIFJFRkVSRU5DRVMgcHJvbXB0X2NhcmRzKGlkKVxuICAgICAgKVxuICAgIGApO1xuXG4gICAgLy8gQ3JlYXRlIGFzc2VydGlvbl90eXBlcyB0YWJsZSBmb3IgYWR2YW5jZWQgYXNzZXJ0aW9uIHN5c3RlbVxuICAgIGF3YWl0IGRiLmV4ZWMoYFxuICAgICAgQ1JFQVRFIFRBQkxFIElGIE5PVCBFWElTVFMgYXNzZXJ0aW9uX3R5cGVzIChcbiAgICAgICAgaWQgSU5URUdFUiBQUklNQVJZIEtFWSBBVVRPSU5DUkVNRU5ULFxuICAgICAgICBuYW1lIFRFWFQgVU5JUVVFIE5PVCBOVUxMLFxuICAgICAgICBkZXNjcmlwdGlvbiBURVhUIE5PVCBOVUxMLFxuICAgICAgICBwYXJhbWV0ZXJzIFRFWFQgTk9UIE5VTEwsIC0tIEpTT05cbiAgICAgICAgZXhhbXBsZXMgVEVYVCBOT1QgTlVMTCwgLS0gSlNPTlxuICAgICAgICB2YWxpZGF0b3JfY29kZSBURVhUIE5PVCBOVUxMLFxuICAgICAgICBjcmVhdGVkX2F0IERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICAgIHVwZGF0ZWRfYXQgREFURVRJTUUgREVGQVVMVCBDVVJSRU5UX1RJTUVTVEFNUFxuICAgICAgKVxuICAgIGApO1xuXG4gICAgLy8gQ3JlYXRlIGFzc2VydGlvbiBleGVjdXRpb24gc3RhdHMgdGFibGVcbiAgICBhd2FpdCBkYi5leGVjKGBcbiAgICAgIENSRUFURSBUQUJMRSBJRiBOT1QgRVhJU1RTIGFzc2VydGlvbl9leGVjdXRpb25fc3RhdHMgKFxuICAgICAgICBpZCBJTlRFR0VSIFBSSU1BUlkgS0VZIEFVVE9JTkNSRU1FTlQsXG4gICAgICAgIGFzc2VydGlvbl90eXBlIFRFWFQgTk9UIE5VTEwsXG4gICAgICAgIHRvdGFsX2V4ZWN1dGlvbnMgSU5URUdFUiBERUZBVUxUIDAsXG4gICAgICAgIHN1Y2Nlc3NmdWxfZXhlY3V0aW9ucyBJTlRFR0VSIERFRkFVTFQgMCxcbiAgICAgICAgZmFpbGVkX2V4ZWN1dGlvbnMgSU5URUdFUiBERUZBVUxUIDAsXG4gICAgICAgIHRvdGFsX2V4ZWN1dGlvbl90aW1lIElOVEVHRVIgREVGQVVMVCAwLFxuICAgICAgICBsYXN0X2V4ZWN1dGVkIERBVEVUSU1FIERFRkFVTFQgQ1VSUkVOVF9USU1FU1RBTVAsXG4gICAgICAgIFVOSVFVRShhc3NlcnRpb25fdHlwZSlcbiAgICAgIClcbiAgICBgKTtcblxuICAgIC8vIENyZWF0ZSBpbmRleGVzIGZvciBiZXR0ZXIgcGVyZm9ybWFuY2VcbiAgICBhd2FpdCBkYi5leGVjKGBcbiAgICAgIENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF9wcm9tcHRfY2FyZHNfdGl0bGUgT04gcHJvbXB0X2NhcmRzKHRpdGxlKTtcbiAgICAgIENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF90ZXN0X2Nhc2VzX3Byb21wdF9jYXJkX2lkIE9OIHRlc3RfY2FzZXMocHJvbXB0X2NhcmRfaWQpO1xuICAgICAgQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X3Rlc3RfcmVzdWx0c190ZXN0X2Nhc2VfaWQgT04gdGVzdF9yZXN1bHRzKHRlc3RfY2FzZV9pZCk7XG4gICAgICBDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfdGVzdF9yZXN1bHRzX2V4ZWN1dGlvbl9pZCBPTiB0ZXN0X3Jlc3VsdHMoZXhlY3V0aW9uX2lkKTtcbiAgICAgIENSRUFURSBJTkRFWCBJRiBOT1QgRVhJU1RTIGlkeF90ZXN0X3F1ZXVlX3N0YXR1cyBPTiB0ZXN0X2V4ZWN1dGlvbl9xdWV1ZShzdGF0dXMpO1xuICAgICAgQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X3Rlc3RfcXVldWVfcHJpb3JpdHkgT04gdGVzdF9leGVjdXRpb25fcXVldWUocHJpb3JpdHkgREVTQyk7XG4gICAgICBDUkVBVEUgSU5ERVggSUYgTk9UIEVYSVNUUyBpZHhfYXNzZXJ0aW9uX3R5cGVzX25hbWUgT04gYXNzZXJ0aW9uX3R5cGVzKG5hbWUpO1xuICAgICAgQ1JFQVRFIElOREVYIElGIE5PVCBFWElTVFMgaWR4X2Fzc2VydGlvbl9zdGF0c190eXBlIE9OIGFzc2VydGlvbl9leGVjdXRpb25fc3RhdHMoYXNzZXJ0aW9uX3R5cGUpO1xuICAgIGApO1xuXG4gICAgY29uc29sZS5sb2coJ0RhdGFiYXNlIGluaXRpYWxpemVkIHN1Y2Nlc3NmdWxseScpO1xuICAgIHJldHVybiBkYjtcbiAgfSBjYXRjaCAoZXJyb3IpIHtcbiAgICBjb25zb2xlLmVycm9yKCdFcnJvciBpbml0aWFsaXppbmcgZGF0YWJhc2U6JywgZXJyb3IpO1xuICAgIHRocm93IGVycm9yO1xuICB9XG59XG5cbi8vIEdyYWNlZnVsIHNodXRkb3duXG5wcm9jZXNzLm9uKCdTSUdJTlQnLCAoKSA9PiB7XG4gIGNvbnNvbGUubG9nKCdDbG9zaW5nIGRhdGFiYXNlIGNvbm5lY3Rpb24uLi4nKTtcbiAgZGIuY2xvc2UoKTtcbiAgcHJvY2Vzcy5leGl0KDApO1xufSk7XG5cbmV4cG9ydCBkZWZhdWx0IGRiOyJdLCJ2ZXJzaW9uIjozfQ==