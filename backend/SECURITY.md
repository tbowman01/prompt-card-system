# Security Implementation Guide\n\nThis document outlines the comprehensive security enhancements implemented in the Prompt Card System backend.\n\n## 🔒 Security Features Implemented\n\n### 1. Rate Limiting\n\n**Location**: `src/middleware/rateLimiting.ts`\n\n- **General API Rate Limit**: 100 requests per 15 minutes per IP\n- **Authentication Rate Limit**: 5 attempts per 15 minutes per IP\n- **Test Execution Rate Limit**: 20 executions per 5 minutes per IP\n- **Heavy Operations Rate Limit**: 10 operations per hour per IP\n- **Speed Limiter**: Progressive delay after 50 requests\n\n**Redis Support**: Ready for Redis-based distributed rate limiting (commented out for development)\n\n### 2. JWT Authentication & Authorization\n\n**Location**: `src/middleware/auth.ts`\n\n- **Secure Token Generation**: Strong JWT secrets with configurable expiry\n- **Token Refresh Mechanism**: Separate refresh tokens with longer validity\n- **Token Blacklisting**: In-memory blacklist (Redis recommended for production)\n- **Role-Based Access Control (RBAC)**: Admin, user, moderator roles\n- **Permission-Based Access**: Granular permissions (read, write, delete, admin)\n- **Password Security**: bcrypt hashing with 12 salt rounds\n\n### 3. Enhanced Input Validation\n\n**Location**: `src/middleware/validation.ts`\n\n- **Joi Schema Validation**: Enhanced with security rules\n- **Express-Validator**: Additional validation layer\n- **XSS Protection**: DOMPurify and sanitize-html\n- **Input Sanitization**: Global request body sanitization\n- **Request Size Limiting**: Configurable payload size limits\n- **Pattern Validation**: Whitelist approach for allowed characters\n\n### 4. Security Headers & Middleware\n\n**Location**: `src/middleware/security.ts`\n\n- **Helmet Configuration**: Enhanced security headers\n- **Content Security Policy**: Strict CSP with development/production modes\n- **CSRF Protection**: Token-based CSRF protection\n- **Request ID Tracing**: Unique request IDs for security logging\n- **IP Whitelisting**: Admin endpoint protection\n- **File Upload Security**: MIME type and size validation\n\n### 5. Authentication Routes\n\n**Location**: `src/routes/auth.ts`\n\n- **User Registration**: Secure user creation with validation\n- **User Login**: Credential verification with rate limiting\n- **Token Refresh**: Secure token renewal mechanism\n- **Password Change**: Current password verification required\n- **User Management**: Admin-only user management endpoints\n- **Account Security**: Self-service security features\n\n## 🛡️ Security Headers Implemented\n\n```http\nX-Frame-Options: DENY\nX-Content-Type-Options: nosniff\nX-XSS-Protection: 1; mode=block\nStrict-Transport-Security: max-age=31536000; includeSubDomains; preload\nReferrer-Policy: no-referrer\nContent-Security-Policy: [Configured policy]\nX-DNS-Prefetch-Control: off\nX-Download-Options: noopen\nX-Permitted-Cross-Domain-Policies: none\n```\n\n## 🔧 Configuration\n\n### Environment Variables\n\nCopy `.env.security.example` to `.env` and configure:\n\n```bash\n# JWT Configuration\nJWT_SECRET=your-super-secret-jwt-key-change-in-production\nJWT_REFRESH_SECRET=your-super-secret-refresh-key-change-in-production\nJWT_EXPIRY=15m\nJWT_REFRESH_EXPIRY=7d\n\n# CORS Configuration\nCORS_ORIGIN=http://localhost:3000,https://yourdomain.com\n\n# Redis (for distributed rate limiting)\nREDIS_URL=redis://localhost:6379\n\n# API Keys\nAPI_KEYS=your-api-key-1,your-api-key-2\n```\n\n### Rate Limiting Configuration\n\n```javascript\n// Customize rate limits in src/middleware/rateLimiting.ts\nexport const customRateLimit = rateLimit({\n  windowMs: 15 * 60 * 1000, // 15 minutes\n  max: 100, // requests per window\n  message: 'Rate limit exceeded'\n});\n```\n\n## 🚀 Production Deployment Checklist\n\n### ✅ Before Production\n\n1. **Update JWT Secrets**\n   ```bash\n   # Generate strong secrets (32+ characters)\n   openssl rand -base64 32\n   ```\n\n2. **Configure Redis**\n   ```bash\n   # Enable Redis for distributed rate limiting\n   # Uncomment Redis store in rateLimiting.ts\n   ```\n\n3. **Set Proper CORS Origins**\n   ```bash\n   CORS_ORIGIN=https://yourapp.com,https://api.yourapp.com\n   ```\n\n4. **Enable HTTPS Only**\n   ```bash\n   FORCE_HTTPS=true\n   SECURE_COOKIES=true\n   ```\n\n5. **Configure CSP**\n   ```javascript\n   // Update contentSecurityPolicy in security.ts\n   // Remove 'unsafe-inline' and localhost entries\n   ```\n\n6. **Set Up Monitoring**\n   ```bash\n   SECURITY_WEBHOOK_URL=https://your-monitoring-service.com/webhook\n   ENABLE_SECURITY_ALERTS=true\n   ```\n\n### 🔍 Security Monitoring\n\n**Request Logging**: All security-relevant requests are logged\n**Rate Limit Monitoring**: Track rate limit hits and patterns\n**Authentication Monitoring**: Monitor failed login attempts\n**CSRF Monitoring**: Track CSRF token validation failures\n\n## 📊 API Usage Examples\n\n### Authentication Flow\n\n```javascript\n// 1. Register a new user\nPOST /api/auth/register\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"SecurePass123!\",\n  \"confirmPassword\": \"SecurePass123!\"\n}\n\n// 2. Login\nPOST /api/auth/login\n{\n  \"email\": \"user@example.com\",\n  \"password\": \"SecurePass123!\"\n}\n\n// Response includes tokens\n{\n  \"success\": true,\n  \"data\": {\n    \"user\": { ... },\n    \"tokens\": {\n      \"accessToken\": \"jwt-access-token\",\n      \"refreshToken\": \"jwt-refresh-token\"\n    }\n  }\n}\n\n// 3. Use access token\nGET /api/auth/me\nAuthorization: Bearer jwt-access-token\n\n// 4. Refresh token when expired\nPOST /api/auth/refresh\n{\n  \"refreshToken\": \"jwt-refresh-token\"\n}\n```\n\n### CSRF Protection\n\n```javascript\n// 1. Get CSRF token\nGET /api/security/csrf-token\n\n// Response\n{\n  \"success\": true,\n  \"data\": {\n    \"csrfToken\": \"csrf-token-here\",\n    \"sessionId\": \"session-id-here\"\n  }\n}\n\n// 2. Use CSRF token in requests\nPOST /api/prompt-cards\nX-CSRF-Token: csrf-token-here\nX-Session-ID: session-id-here\n```\n\n## 🐛 Troubleshooting\n\n### Common Issues\n\n1. **Rate Limit Exceeded**\n   - Check rate limit headers in response\n   - Implement exponential backoff\n   - Consider IP whitelisting for development\n\n2. **CSRF Token Invalid**\n   - Ensure CSRF token is fresh (1-hour expiry)\n   - Include both X-CSRF-Token and X-Session-ID headers\n\n3. **JWT Token Expired**\n   - Use refresh token to get new access token\n   - Implement automatic token refresh\n\n4. **CORS Errors**\n   - Update CORS_ORIGIN environment variable\n   - Ensure origin matches exactly (including protocol)\n\n## 🔧 Customization\n\n### Adding New Roles\n\n```javascript\n// In src/middleware/auth.ts\nconst ROLES = {\n  ADMIN: 'admin',\n  MODERATOR: 'moderator',\n  USER: 'user',\n  GUEST: 'guest' // New role\n};\n\n// Use in routes\nrouter.get('/admin-only', verifyToken, requireRole(['admin']));\nrouter.get('/mod-and-admin', verifyToken, requireRole(['admin', 'moderator']));\n```\n\n### Custom Rate Limits\n\n```javascript\n// Create custom rate limiter\nexport const customEndpointRateLimit = rateLimit({\n  windowMs: 5 * 60 * 1000, // 5 minutes\n  max: 10, // 10 requests per 5 minutes\n  message: 'Custom endpoint rate limit exceeded'\n});\n\n// Apply to specific routes\nrouter.post('/heavy-operation', customEndpointRateLimit, handler);\n```\n\n### Custom Validation\n\n```javascript\n// Add custom validation rules\nconst customValidation = [\n  body('customField')\n    .custom((value) => {\n      // Custom validation logic\n      if (!isValid(value)) {\n        throw new Error('Custom validation failed');\n      }\n      return true;\n    }),\n  handleValidationErrors\n];\n```\n\n## 📋 Security Audit Checklist\n\n- [ ] JWT secrets are strong and unique\n- [ ] Rate limiting is enabled and configured\n- [ ] HTTPS is enforced in production\n- [ ] CORS origins are properly configured\n- [ ] CSP headers are restrictive\n- [ ] Input validation covers all endpoints\n- [ ] SQL injection protection is in place\n- [ ] XSS protection is implemented\n- [ ] CSRF protection is enabled\n- [ ] Authentication is required for sensitive operations\n- [ ] Authorization checks are in place\n- [ ] Sensitive data is not logged\n- [ ] Error messages don't leak information\n- [ ] File uploads are secured\n- [ ] Dependencies are up to date\n- [ ] Security headers are configured\n- [ ] Request logging is enabled\n- [ ] Monitoring and alerting are set up\n\n## 🆘 Security Incident Response\n\n1. **Identify the Issue**: Check logs and monitoring alerts\n2. **Immediate Actions**: \n   - Block malicious IPs if needed\n   - Revoke compromised tokens\n   - Increase rate limits temporarily\n3. **Investigation**: Analyze logs and request patterns\n4. **Remediation**: Apply fixes and security patches\n5. **Prevention**: Update security rules and monitoring\n\n## 📞 Support\n\nFor security-related questions or to report vulnerabilities:\n- Review this documentation\n- Check the security logs\n- Contact the development team\n- For critical security issues, follow responsible disclosure\n\n---\n\n**Remember**: Security is an ongoing process. Regularly review and update these configurations based on new threats and best practices.